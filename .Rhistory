source("~/Documents/Github/cfi-map2-data/R/viz_functions.R", echo=TRUE)
fig_flex(fig_data, vars, facets = facets, figparams, scales, legend, labels, coord_flip = TRUE)
View(fig_data)
figparams <- list(
geom_type = "bar", # One of "bar" or "tile"
bars = list(width = 0.8, position = "stack", labeltotal = TRUE, labeltotal_ndgy = FALSE, labeltotal_extendmax = FALSE, color = "white"),
valuelabels = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0.5, lab_face = "plain", lab_size = 3.5),
catlabels = list(show = FALSE),
errorbars = list(show = FALSE, color = "blue")
)
palette <- c("#41BBD9", "#FF9F1C")
names(palette) <- c("1-10 people", "More than 10 people")
scales <- list(
fillcolor = list(palette = palette),
yaxis = list(limits = c(0, 1), nbreaks = 5, type = "number", expand = c(0,0), droplines = FALSE)
)
legend <- list(
show = TRUE,
title = "Business size:",
nrows = 1,
ncols = 1,
reverse = TRUE
)
labels <- list(
title = "Total estimated business population and population density in each study area",
subtitle =  NULL,
yax_ti = NULL,
xax_ti = NULL,
caption = NULL
)
vars <- list(
xvar = "city", yvar = "total", fillvar = "group_cat_val"
)
facets <- list(
type = "grid",
rows = "indicator_group",
cols = "indicator_name",
scales = "free",
space = "free",
drop_row_label = TRUE,
drop_col_label = FALSE,
add_dividers = FALSE
)
fig_flex(fig_data, vars, facets = facets, figparams, scales, legend, labels, coord_flip = TRUE)
source("~/Documents/Github/cfi-map2-data/R/viz_functions.R", echo=TRUE)
fig_flex(fig_data, vars, facets = facets, figparams, scales, legend, labels, coord_flip = TRUE)
p
p
p
facets <- list(
type = "grid",
rows = "indicator_group",
cols = "indicator_name",
scales = "free_y",
space = "free",
drop_row_label = TRUE,
drop_col_label = FALSE,
add_dividers = FALSE
)
fig_flex(fig_data, vars, facets = facets, figparams, scales, legend, labels, coord_flip = TRUE)
p
p
#| label: fig-nbus_size_and_sector
#| echo: false
#| warning: false
#| fig-cap: "Businesses enumerated by size and sector"
# Number of firms by size and sector
indicators <- c("business_total")
groups_l1 <- "country"
groups_l2 <- GROUPS[c("business_size_agg2")]
get_grid_area <- function(c) {
WEIGHT_PARAMS[[c]][["grid_area"]]
}
ests_total <- compute_summary_clusterlevel_2g(indicators, groups_l1, groups_l2, enum_data_all, keep = "total")
ests_density <- ests_total %>%
mutate(
indicator_name = "Total businesses per km2",
grid_area = map_dbl(country, get_grid_area),
total = total/grid_area,
total_low = total_low/grid_area,
total_upp = total_upp/grid_area
)
ests <- bind_rows(ests_total, ests_density)
factor_params <- list(
wrap_sizes = list(indicator_name = 40, indicator_group = 40, group_name = 40, group_cat_val = 60),
reverse_order = list(indicator_name = FALSE, indicator_group = FALSE, group_name = FALSE, group_cat_val = TRUE),
order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)
fig_data <- prep_fig_data(ests, factor_params, include_valuelabel = TRUE, valuelabel_target = "total", valuelabel_type = "num") %>%
mutate(
city = CITIES[country]
) %>%
group_by(city, indicator_name) %>%
mutate(
size_total = sum(total),
share = total/size_total,
valuelabel = paste0(pctclean(share, 0), "%"),
#valuelabel = ifelse(total < 1e5, NA, valuelabel),
barlabel = ifelse(group_cat_val == "More than 10 people", numclean(size_total), NA),
barlabelpos = ifelse(group_cat_val == "More than 10 people", size_total, NA),
)
# Parameters to create figure
figparams <- list(
geom_type = "bar", # One of "bar" or "tile"
bars = list(width = 0.8, position = "stack", labeltotal = TRUE, labeltotal_ndgy = FALSE, labeltotal_extendmax = FALSE, color = "white"),
valuelabels = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0.5, lab_face = "plain", lab_size = 3.5),
catlabels = list(show = FALSE),
errorbars = list(show = FALSE, color = "blue")
)
palette <- c("#41BBD9", "#FF9F1C")
names(palette) <- c("1-10 people", "More than 10 people")
scales <- list(
fillcolor = list(palette = palette),
yaxis = list(limits = c(0, 1), nbreaks = 5, type = "number", expand = c(0,0), droplines = FALSE)
)
legend <- list(
show = TRUE,
title = "Business size:",
nrows = 1,
ncols = 1,
reverse = TRUE
)
labels <- list(
title = "Total estimated business population and population density in each study area",
subtitle =  NULL,
yax_ti = NULL,
xax_ti = NULL,
caption = NULL
)
vars <- list(
xvar = "city", yvar = "total", fillvar = "group_cat_val"
)
facets <- list(
type = "wrap",
rows = "indicator_group",
cols = "indicator_name",
scales = "free_y",
space = "free",
drop_row_label = TRUE,
drop_col_label = FALSE,
add_dividers = FALSE
)
fig_flex(fig_data, vars, facets = facets, figparams, scales, legend, labels, coord_flip = TRUE)
source("~/Documents/Github/cfi-map2-data/R/viz_functions.R", echo=TRUE)
#| label: fig-nbus_size_and_sector
#| echo: false
#| warning: false
#| fig-cap: "Businesses enumerated by size and sector"
# Number of firms by size and sector
indicators <- c("business_total")
groups_l1 <- "country"
groups_l2 <- GROUPS[c("business_size_agg2")]
get_grid_area <- function(c) {
WEIGHT_PARAMS[[c]][["grid_area"]]
}
ests_total <- compute_summary_clusterlevel_2g(indicators, groups_l1, groups_l2, enum_data_all, keep = "total")
ests_density <- ests_total %>%
mutate(
indicator_name = "Total businesses per km2",
grid_area = map_dbl(country, get_grid_area),
total = total/grid_area,
total_low = total_low/grid_area,
total_upp = total_upp/grid_area
)
ests <- bind_rows(ests_total, ests_density)
factor_params <- list(
wrap_sizes = list(indicator_name = 40, indicator_group = 40, group_name = 40, group_cat_val = 60),
reverse_order = list(indicator_name = FALSE, indicator_group = FALSE, group_name = FALSE, group_cat_val = TRUE),
order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)
fig_data <- prep_fig_data(ests, factor_params, include_valuelabel = TRUE, valuelabel_target = "total", valuelabel_type = "num") %>%
mutate(
city = CITIES[country]
) %>%
group_by(city, indicator_name) %>%
mutate(
size_total = sum(total),
share = total/size_total,
valuelabel = paste0(pctclean(share, 0), "%"),
#valuelabel = ifelse(total < 1e5, NA, valuelabel),
barlabel = ifelse(group_cat_val == "More than 10 people", numclean(size_total), NA),
barlabelpos = ifelse(group_cat_val == "More than 10 people", size_total, NA),
)
# Parameters to create figure
figparams <- list(
geom_type = "bar", # One of "bar" or "tile"
bars = list(width = 0.8, position = "stack", labeltotal = TRUE, labeltotal_ndgy = FALSE, labeltotal_extendmax = FALSE, color = "white"),
valuelabels = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0.5, lab_face = "plain", lab_size = 3.5),
catlabels = list(show = FALSE),
errorbars = list(show = FALSE, color = "blue")
)
palette <- c("#41BBD9", "#FF9F1C")
names(palette) <- c("1-10 people", "More than 10 people")
scales <- list(
fillcolor = list(palette = palette),
yaxis = list(limits = c(0, 1), nbreaks = 5, type = "number", expand = c(0,0), droplines = FALSE)
)
legend <- list(
show = TRUE,
title = "Business size:",
nrows = 1,
ncols = 1,
reverse = TRUE
)
labels <- list(
title = "Total estimated business population and population density in each study area",
subtitle =  NULL,
yax_ti = NULL,
xax_ti = NULL,
caption = NULL
)
vars <- list(
xvar = "city", yvar = "total", fillvar = "group_cat_val"
)
facets <- list(
type = "wrap",
rows = "indicator_group",
cols = "indicator_name",
scales = "free_y",
space = "free",
drop_row_label = TRUE,
drop_col_label = FALSE,
add_dividers = FALSE
)
fig_flex(fig_data, vars, facets = facets, figparams, scales, legend, labels, coord_flip = TRUE)
source("~/Documents/Github/cfi-map2-data/R/viz_functions.R", echo=TRUE)
#| label: fig-nbus_size_and_sector
#| echo: false
#| warning: false
#| fig-cap: "Businesses enumerated by size and sector"
# Number of firms by size and sector
indicators <- c("business_total")
groups_l1 <- "country"
groups_l2 <- GROUPS[c("business_size_agg2")]
get_grid_area <- function(c) {
WEIGHT_PARAMS[[c]][["grid_area"]]
}
ests_total <- compute_summary_clusterlevel_2g(indicators, groups_l1, groups_l2, enum_data_all, keep = "total")
ests_density <- ests_total %>%
mutate(
indicator_name = "Total businesses per km2",
grid_area = map_dbl(country, get_grid_area),
total = total/grid_area,
total_low = total_low/grid_area,
total_upp = total_upp/grid_area
)
ests <- bind_rows(ests_total, ests_density)
factor_params <- list(
wrap_sizes = list(indicator_name = 40, indicator_group = 40, group_name = 40, group_cat_val = 60),
reverse_order = list(indicator_name = FALSE, indicator_group = FALSE, group_name = FALSE, group_cat_val = TRUE),
order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)
fig_data <- prep_fig_data(ests, factor_params, include_valuelabel = TRUE, valuelabel_target = "total", valuelabel_type = "num") %>%
mutate(
city = CITIES[country]
) %>%
group_by(city, indicator_name) %>%
mutate(
size_total = sum(total),
share = total/size_total,
valuelabel = paste0(pctclean(share, 0), "%"),
#valuelabel = ifelse(total < 1e5, NA, valuelabel),
barlabel = ifelse(group_cat_val == "More than 10 people", numclean(size_total), NA),
barlabelpos = ifelse(group_cat_val == "More than 10 people", size_total, NA),
)
# Parameters to create figure
figparams <- list(
geom_type = "bar", # One of "bar" or "tile"
bars = list(width = 0.8, position = "stack", labeltotal = TRUE, labeltotal_ndgy = FALSE, labeltotal_extendmax = FALSE, color = "white"),
valuelabels = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0.5, lab_face = "plain", lab_size = 3.5),
catlabels = list(show = FALSE),
errorbars = list(show = FALSE, color = "blue")
)
palette <- c("#41BBD9", "#FF9F1C")
names(palette) <- c("1-10 people", "More than 10 people")
scales <- list(
fillcolor = list(palette = palette),
yaxis = list(nbreaks = 5, type = "number", expand = c(0,0), droplines = FALSE)
)
legend <- list(
show = TRUE,
title = "Business size:",
nrows = 1,
ncols = 1,
reverse = TRUE
)
labels <- list(
title = "Total estimated business population and population density in each study area",
subtitle =  NULL,
yax_ti = NULL,
xax_ti = NULL,
caption = NULL
)
vars <- list(
xvar = "city", yvar = "total", fillvar = "group_cat_val"
)
facets <- list(
type = "wrap",
rows = "indicator_group",
cols = "indicator_name",
scales = "free",
space = "free",
drop_row_label = TRUE,
drop_col_label = FALSE,
add_dividers = FALSE
)
fig_flex(fig_data, vars, facets = facets, figparams, scales, legend, labels, coord_flip = TRUE)
#| label: fig-nbus_size_and_sector
#| echo: false
#| warning: false
#| fig-cap: "Businesses enumerated by size and sector"
# Number of firms by size and sector
indicators <- c("business_total")
groups_l1 <- "country"
groups_l2 <- GROUPS[c("business_sector_agg3")]
get_grid_area <- function(c) {
WEIGHT_PARAMS[[c]][["grid_area"]]
}
ests <- compute_summary_clusterlevel_2g(indicators, groups_l1, groups_l2, enum_data_all, keep = "total")
factor_params <- list(
wrap_sizes = list(indicator_name = 40, indicator_group = 40, group_name = 40, group_cat_val = 60),
reverse_order = list(indicator_name = FALSE, indicator_group = FALSE, group_name = FALSE, group_cat_val = TRUE),
order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)
fig_data <- prep_fig_data(ests, factor_params, include_valuelabel = TRUE, valuelabel_target = "total", valuelabel_type = "num") %>%
mutate(
city = CITIES[country]
)
# Parameters to create figure
figparams <- list(
geom_type = "bar", # One of "bar" or "tile"
bars = list(width = 0.8, position = "stack", labeltotal = TRUE, labeltotal_ndgy = FALSE, labeltotal_extendmax = FALSE, color = "white"),
valuelabels = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0.5, lab_face = "plain", lab_size = 3.5),
catlabels = list(show = FALSE),
errorbars = list(show = FALSE, color = "blue")
)
palette <- c("#41BBD9", "#CEE5F2", "#FF9F1C")
names(palette) <- c("Services: retail/wholesale trade (re-sale)", "Services: transportation, construction, repair, other", "Manufacturing")
scales <- list(
fillcolor = list(palette = palette),
yaxis = list(nbreaks = 5, type = "number", expand = c(0,0), droplines = FALSE)
)
legend <- list(
show = TRUE,
title = "Business size:",
nrows = 1,
ncols = 1,
reverse = TRUE
)
labels <- list(
title = "Total estimated business population and population density in each study area",
subtitle =  NULL,
yax_ti = NULL,
xax_ti = NULL,
caption = NULL
)
vars <- list(
xvar = "city", yvar = "total", fillvar = "group_cat_val"
)
fig_flex(fig_data, vars, facets = NULL, figparams, scales, legend, labels, coord_flip = TRUE)
indicators <- c("business_total")
groups_l1 <- "city"
groups_l2 <- GROUPS[c("business_sector_agg3")]
ests <- compute_summary_clusterlevel_2g(indicators, groups_l1, groups_l2, enum_data_all, keep = "total")
factor_params <- list(
wrap_sizes = list(indicator_name = 40, indicator_group = 40, group_name = 40, group_cat_val = 60),
reverse_order = list(indicator_name = FALSE, indicator_group = FALSE, group_name = FALSE, group_cat_val = TRUE),
order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)
fig_data <- prep_fig_data(ests, factor_params, include_valuelabel = TRUE, valuelabel_target = "total", valuelabel_type = "num")
View(fig_data)
figparams <- list(
geom_type = "bar", # One of "bar" or "tile"
bars = list(width = 0.8, position = "stack", labeltotal = TRUE, labeltotal_ndgy = FALSE, labeltotal_extendmax = FALSE, color = "white"),
valuelabels = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0.5, lab_face = "plain", lab_size = 3.5),
catlabels = list(show = FALSE),
errorbars = list(show = FALSE, color = "blue")
)
palette <- c("#41BBD9", "#CEE5F2", "#FF9F1C")
names(palette) <- c("Services: retail/wholesale trade (re-sale)", "Services: transportation, construction, repair, other", "Manufacturing")
scales <- list(
fillcolor = list(palette = palette),
yaxis = list(nbreaks = 5, type = "number", expand = c(0,0), droplines = FALSE)
)
legend <- list(
show = TRUE,
title = "Business size:",
nrows = 1,
ncols = 1,
reverse = TRUE
)
labels <- list(
title = "Total estimated business population and population density in each study area",
subtitle =  NULL,
yax_ti = NULL,
xax_ti = NULL,
caption = NULL
)
vars <- list(
xvar = "city", yvar = "total", fillvar = "group_cat_val"
)
fig_flex(fig_data, vars, facets = NULL, figparams, scales, legend, labels, coord_flip = TRUE)
#| label: fig-nbus_size_and_sector
#| echo: false
#| warning: false
#| fig-cap: "Businesses enumerated by size and sector"
# Number of firms by size and sector
indicators <- c("business_total")
groups_l1 <- "city"
groups_l2 <- GROUPS[c("business_sector_agg3")]
ests <- compute_summary_clusterlevel_2g(indicators, groups_l1, groups_l2, enum_data_all, keep = "total")
factor_params <- list(
wrap_sizes = list(indicator_name = 40, indicator_group = 40, group_name = 40, group_cat_val = 60),
reverse_order = list(indicator_name = FALSE, indicator_group = FALSE, group_name = FALSE, group_cat_val = TRUE),
order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)
fig_data <- prep_fig_data(ests, factor_params, include_valuelabel = TRUE, valuelabel_target = "total", valuelabel_type = "num") %>% group_by(city, indicator_name) %>%
mutate(
size_total = sum(total),
share = total/size_total,
valuelabel = paste0(pctclean(share, 0), "%"),
#valuelabel = ifelse(total < 1e5, NA, valuelabel),
barlabel = ifelse(group_cat_val == "Services: transportation, construction, repair, other", numclean(size_total), NA),
barlabelpos = ifelse(group_cat_val == "Services: transportation, construction, repair, other", size_total, NA),
)
# Parameters to create figure
figparams <- list(
geom_type = "bar", # One of "bar" or "tile"
bars = list(width = 0.8, position = "stack", labeltotal = TRUE, labeltotal_ndgy = FALSE, labeltotal_extendmax = FALSE, color = "white"),
valuelabels = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0.5, lab_face = "plain", lab_size = 3.5),
catlabels = list(show = FALSE),
errorbars = list(show = FALSE, color = "blue")
)
palette <- c("#41BBD9", "#CEE5F2", "#FF9F1C")
names(palette) <- c("Services: retail/wholesale trade (re-sale)", "Services: transportation, construction, repair, other", "Manufacturing")
scales <- list(
fillcolor = list(palette = palette),
yaxis = list(nbreaks = 5, type = "number", expand = c(0,0), droplines = FALSE)
)
legend <- list(
show = TRUE,
title = "Business size:",
nrows = 1,
ncols = 1,
reverse = TRUE
)
labels <- list(
title = "Total estimated business population and population density in each study area",
subtitle =  NULL,
yax_ti = NULL,
xax_ti = NULL,
caption = NULL
)
vars <- list(
xvar = "city", yvar = "total", fillvar = "group_cat_val"
)
fig_flex(fig_data, vars, facets = NULL, figparams, scales, legend, labels, coord_flip = TRUE)
#| label: fig-nbus_size_and_sector
#| echo: false
#| warning: false
#| fig-cap: "Businesses enumerated by size and sector"
# Number of firms by size and sector
indicators <- c("business_total")
groups_l1 <- "city"
groups_l2 <- GROUPS[c("business_sector_agg3")]
ests <- compute_summary_clusterlevel_2g(indicators, groups_l1, groups_l2, enum_data_all, keep = "total")
factor_params <- list(
wrap_sizes = list(indicator_name = 40, indicator_group = 40, group_name = 40, group_cat_val = 60),
reverse_order = list(indicator_name = FALSE, indicator_group = FALSE, group_name = FALSE, group_cat_val = TRUE),
order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)
fig_data <- prep_fig_data(ests, factor_params, include_valuelabel = TRUE, valuelabel_target = "total", valuelabel_type = "num") %>% group_by(city, indicator_name) %>%
mutate(
size_total = sum(total),
share = total/size_total,
valuelabel = paste0(pctclean(share, 0), "%"),
#valuelabel = ifelse(total < 1e5, NA, valuelabel),
barlabel = ifelse(group_cat_val == "Services: transportation, construction, repair, other", numclean(size_total), NA),
barlabelpos = ifelse(group_cat_val == "Services: transportation, construction, repair, other", size_total, NA),
)
# Parameters to create figure
figparams <- list(
geom_type = "bar", # One of "bar" or "tile"
bars = list(width = 0.8, position = "stack", labeltotal = TRUE, labeltotal_ndgy = TRUE, labeltotal_extendmax = TRUE, color = "white"),
valuelabels = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0.5, lab_face = "plain", lab_size = 3.5),
catlabels = list(show = FALSE),
errorbars = list(show = FALSE, color = "blue")
)
palette <- c("#41BBD9", "#CEE5F2", "#FF9F1C")
names(palette) <- c("Services: retail/wholesale trade (re-sale)", "Services: transportation, construction, repair, other", "Manufacturing")
scales <- list(
fillcolor = list(palette = palette),
yaxis = list(nbreaks = 5, type = "number", expand = c(0,0), droplines = FALSE)
)
legend <- list(
show = TRUE,
title = "Business size:",
nrows = 1,
ncols = 1,
reverse = TRUE
)
labels <- list(
title = "Total estimated business population and population density in each study area",
subtitle =  NULL,
yax_ti = NULL,
xax_ti = NULL,
caption = NULL
)
vars <- list(
xvar = "city", yvar = "total", fillvar = "group_cat_val"
)
fig_flex(fig_data, vars, facets = NULL, figparams, scales, legend, labels, coord_flip = TRUE)

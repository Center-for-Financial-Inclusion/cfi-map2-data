
---
title: "Global"
lightbox: true
---


```{r}
#| include: false

# Importing packaegs, functions declaring globals
source("R/packages.R")
source("R/utils.R")
source("R/globals.R")
source("R/functions.R")
source("R/viz_functions.R")
source("R/0_global_main_data.R")
source("R/specific_functions.R")

# Preparing and combining the enumeration data for all countries
enum_data_all <- bind_rows(
  map(COUNTRIES, compile_enumdata, weight_params = WEIGHT_PARAMS)
) %>% mutate(
  city = CITIES[country]
)

# Preparing and combining all of the main interview data for all countries
main_data_all <- bind_rows(
  map(COUNTRIES, compile_maindata, weight_params = WEIGHT_PARAMS)
) %>% mutate(
  city = CITIES[country]
)

```

## Key findings


*	This study found between 400 (Addis) and 1,400 (Delhi) visible businesses establishments per square kilometer in 5 major urban centers (@fig-nbus_size_and_sector). 

*	A dominant majority of these visible business establishments are businesses with fewer than 10 workers (Figure 1), though Delhi has a relatively high concentration of larger businesses (40%). 

*	These small businesses are concentrated in retail trade and play a key role in urban food production and distribution. In Jakarta, 76 percent of small firms are involved in food distribution or manufacture, whereas in Addis, Delhi and Lagos, the share ranges from 34 to 47 percent, in Sao Paolo production is more diversified and the share of firms in food distribution or manufcature is lower, making up 25 percent. Among the 5 cities, Lagos has the highest share of small businesses in manufacturing (19%). 

*	At the median, the productivity per worker among these small firms is lower than the level of productivity suggested by national accounts data: the gap is smallest in Sao Paulo (0.95x) and largest in Jakarta (0.13x) (@fig-mses_productivity)

* Based on owner’s or manager’s evaluations, the share of small firms that are ‘growing’ is as low as 4 percent in Jakarta and as high as 25 percent in Lagos. Firms that can be described as ‘static’, that is, revenues and number of employees that have stayed the same over the past year and that have not made investments in capital or products make up as high as 45% of firms in Jakarta and as low as 13% of firms in Lagos. 

*	On average, small business owners are in their 30’s (Addis, Delhi) or in their early 40’s (Sao Paolo, Lagos). The least experienced small firm owners are those in Addis (2.8 years’ experience running the business) and the most experienced are those in Sao Paolo (10 years’ of experience). 

*	Nearly 1 in 2 small businesses in Jakarta and Lagos are owner-operated single person businesses, while the share in Addis, Delhi and Sao Paulo is nearer to 1 in 3. The prevalence of single-person businesses correlates strongly with the share of businesses run out of the household and with the share of businesses run by women. Jakarta and Lagos also have the highest share of businesses run out of the household (60 and 53%, respectively) as well as the highest share of businesses run by women (74 and 53%, respectively). 

*	Around 3 in 4 business owners in Addis, Delhi and Lagos said they wanted to become an entrepreneur in order to start a business. In Sao Paolo and Jakarta, the number is around 1 in 2, and more business owners became entrepreneurs due to lack of opportunities or other reasons. Across all study sites, dominant shares of business owners say their main goal is to grow the business over the next 12 months, however in Brazil a relatively larger share of owners (nearly 1 in 3) say their main goal is to either cover business costs or leave the business. Overall, between 1 in 4 and 1 in 3 business owners can be characterized as having a strong ‘entrepreneurial’ mindset with a desire to grow the business and take risks. 

*	Controlling for education and years of experience, women are less likely to have an ‘entrepreneurial’ or ‘growth and risk’ oriented mindset than men in Addis and Jakarta. In Addis, this finding is driven by a more cautious attitude to risk among women, while in Jakarta in addition to lower risk tolerance, women are substantially less likely than men to identify as an entrepreneur.  

*	This study tracked use of 10 distinct non-financial and financial digital technologies among small businesses. There is wide variation among the study sites in the adoption of these technologies. In Addis, small businesses use 1.6 technologies, whereas in Brazil they use 5, reflecting more widespread adoption of advanced digital solutions such as e-commerce platforms or operations-supporting software and digital loans. 

*	Educational attainment of the owner (or manager) is the single strongest predictor of firm-level technology and this finding is consistent across all 5 cities. 


## The business landscape 

```{r, fig.width = 12, fig.asp = 0.35}
#| label: fig-nbus_size_and_sector
#| echo: false
#| warning: false
#| fig-cap: "Businesses enumerated by size"
#| cap-location: margin

# Number of firms by size and sector

indicators <- c("business_total")
groups_l1 <- "country"
groups_l2 <- GROUPS[c("business_size_agg2")]

get_grid_area <- function(c) { 
     WEIGHT_PARAMS[[c]][["grid_area"]]
}

ests_total <- compute_summary_clusterlevel_2g(indicators, groups_l1, groups_l2, enum_data_all, keep = "total")

ests_density <- ests_total %>% 
  mutate(
      indicator_name = "Total businesses per km2", 
      grid_area = map_dbl(country, get_grid_area),
      total = total/grid_area, 
      total_low = total_low/grid_area, 
      total_upp = total_upp/grid_area
  )

ests <- bind_rows(ests_total, ests_density) %>% mutate(total = ifelse(indicator_name == "Total businesses (N)", total/1000, total))

factor_params <- list(
  wrap_sizes = list(indicator_name = 40, indicator_group = 40, group_name = 40, group_cat_val = 60), 
  reverse_order = list(indicator_name = FALSE, indicator_group = FALSE, group_name = FALSE, group_cat_val = TRUE), 
  order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)

fig_data <- prep_fig_data(ests, factor_params, include_valuelabel = TRUE, valuelabel_target = "total", valuelabel_type = "num") %>%
  mutate(
    city = CITIES[country]
  ) %>% 
  group_by(city, indicator_name) %>% 
  mutate(
      size_total = sum(total),
      share = total/size_total,
      valuelabel = paste0(pctclean(share, 0), "%"),
      valuelabel = ifelse(share < 0.15, NA, valuelabel),
      valuelabel = ifelse(indicator_name == "Total businesses (N)" & share < 0.3, NA, valuelabel), 
      barlabel = ifelse(group_cat_val == "More than 10 people", numclean(size_total), NA),
      barlabel = ifelse(indicator_name == "Total businesses (N)", paste0(barlabel, ",000"), barlabel),
      barlabelpos = ifelse(group_cat_val == "More than 10 people", size_total, NA), 
    ) 

# Parameters to create figure

figparams <- list(
  geom_type = "bar", # One of "bar" or "tile"
  bars = list(width = 0.8, position = "stack", labeltotal = TRUE, labeltotal_ndgy = TRUE, labeltotal_extendmax = TRUE, color = "white"), 
  valuelabels = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0.5, lab_face = "plain", lab_size = 3.5),
  catlabels = list(show = FALSE), 
  errorbars = list(show = FALSE, color = "blue")
)

palette <- c("#41BBD9", "#FF9F1C")
names(palette) <- c("1-10 people", "More than 10 people")

scales <- list(
  fillcolor = list(palette = palette), 
  yaxis = list(nbreaks = 5, type = "number", expand = c(0.1,0.1), droplines = FALSE)
)

legend <- list(
  show = TRUE, 
  title = "Business size:", 
  nrows = 1, 
  ncols = 1, 
  reverse = TRUE
)

labels <- list(
  title = "Total estimated business population and population density in each study area",
  subtitle = "",
  yax_ti = NULL,
  xax_ti = NULL,
  caption = str_wrap(paste(SOURCE, "Notes: The percent of businesses by size is labeled within each bar, while the total number of business is labeled above the bar. Population estimates are based on adaptive cluster sampling weights (see methodology for details)"), CAP_WRAP)
)

vars <- list(
  xvar = "city", yvar = "total", fillvar = "group_cat_val"
)

facets <- list(
  type = "wrap", 
  rows = "indicator_group", 
  cols = "indicator_name", 
  scales = "free_x", 
  space = "free",
  drop_row_label = TRUE, 
  drop_col_label = FALSE, 
  add_dividers = FALSE
)

fig_flex(fig_data, vars, facets = facets, figparams, scales, legend, labels, coord_flip = TRUE) + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())

```

---

```{r, fig.width = 12, fig.asp = 0.35}
#| label: fig-nbus_sector
#| echo: false
#| warning: false
#| fig-cap: "Businesses enumerated by sector"
#| cap-location: margin

# Number of firms by size and sector

indicators <- c("business_total")
groups_l1 <- "city"
groups_l2 <- GROUPS[c("business_sector_agg3")]

ests <- compute_summary_clusterlevel_2g(indicators, groups_l1, groups_l2, enum_data_all %>% filter(business_size_agg2 == "1-10 people"  ), keep = "total") %>% 
  mutate(size = "1-10 people") %>% 
  bind_rows(
    compute_summary_clusterlevel_2g(indicators, groups_l1, groups_l2, enum_data_all %>% filter(business_size_agg2 == "More than 10 people"), keep = "total") %>%  mutate(size = "More than 10 people")
    )

factor_params <- list(
  wrap_sizes = list(indicator_name = 40, indicator_group = 40, group_name = 40, group_cat_val = 60), 
  reverse_order = list(indicator_name = FALSE, indicator_group = FALSE, group_name = FALSE, group_cat_val = TRUE), 
  order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)

fig_data <- prep_fig_data(ests, factor_params, include_valuelabel = TRUE, valuelabel_target = "total", valuelabel_type = "num") %>% group_by(city, indicator_name, size) %>% 
  mutate(
      size_total = sum(total),
      share = total/size_total,
      valuelabel = paste0(pctclean(share, 0), "%"),
      #valuelabel = ifelse(total < 1e5, NA, valuelabel),
      barlabel = ifelse(group_cat_val == "Services: transportation, construction, repair, other", numclean(size_total), NA),
      barlabelpos = ifelse(group_cat_val == "Services: transportation, construction, repair, other", size_total, NA), 
    ) 

# Parameters to create figure

figparams <- list(
  geom_type = "bar", # One of "bar" or "tile"
  bars = list(width = 0.8, position = "stack", labeltotal = TRUE, labeltotal_ndgy = TRUE, labeltotal_extendmax = TRUE, color = "white"), 
  valuelabels = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0.5, lab_face = "plain", lab_size = 3.5),
  catlabels = list(show = FALSE), 
  errorbars = list(show = FALSE, color = "blue")
)

palette <- c("#41BBD9", "#CEE5F2", "#FF9F1C")
names(palette) <- c("Services: retail/wholesale trade (re-sale)", "Services: transportation, construction, repair, other", "Manufacturing")

scales <- list(
  fillcolor = list(palette = palette), 
  yaxis = list(limits = c(0, 1), nbreaks = 5, type = "percent", expand = c(0,0), droplines = FALSE)
)

legend <- list(
  show = TRUE, 
  title = "Business sector:", 
  nrows = 1, 
  ncols = 1, 
  reverse = TRUE
)

labels <- list(
  title = "Share of businesses by industrial sector within size category",
  subtitle =  "Businesses (%)",
  yax_ti = NULL,
  xax_ti = NULL,
  caption = SOURCE
)

vars <- list(
  xvar = "city", yvar = "share", fillvar = "group_cat_val"
)

facets <- list(
  type = "wrap", 
  rows = "indicator_group", 
  cols = "size", 
  scales = "fixed", 
  space = "free",
  drop_row_label = TRUE, 
  drop_col_label = FALSE, 
  add_dividers = FALSE
)

fig_flex(fig_data, vars, facets = facets, figparams, scales, legend, labels, coord_flip = TRUE) + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())

```

---

```{r, fig.width = 12, fig.asp = 0.35}
#| label: fig-sample_chars
#| echo: false
#| warning: false
#| fig-cap: "Sample characteristics"
#| cap-location: margin

# Number of firms by size and sector

indicators <- c("business_size_agg2_shc_1", "business_size_agg2_shc_2_10",  "business_sector_agg3_shc_mfc" , "business_sector_agg3_shc_srv_resale", "business_sector_agg3_shc_srv_oth", "business_premise_shc_1", "business_premise_shc_2", "business_premise_shc_3", "resp_type_owner", "resp_type_manager", "resp_sex_men", "resp_sex_women")

groups <- GROUPS[c("city")]

ests <- compute_summary_mainlevel_1g(indicators, groups, main_data_all, weights = "weight_msme", psu = NULL, keep = "mean")

factor_params <- list(
  wrap_sizes = list(indicator_name = 40, indicator_group = 40, group_name = 40, group_cat_val = 60), 
  reverse_order = list(indicator_name = TRUE, indicator_group = FALSE, group_name = FALSE, group_cat_val = TRUE), 
  order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)

fig_data <- prep_fig_data(ests, factor_params) %>% mutate(valuelabel = ifelse(mean < 0.05, NA, valuelabel))

# Parameters to create figure

figparams <- list(
  geom_type = "bar", # One of "bar" or "tile"
  bars = list(width = 0.8, position = "stack", labeltotal = FALSE, color = "white"), 
  valuelabels = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0.5, lab_face = "plain", lab_size = 3.5),
  catlabels = list(show = FALSE), 
  errorbars = list(show = FALSE)
)

palette <- c("#A2C3A4", "#C4F1BE", "#FF9F1C", "#41BBD9", "#CEE5F2", "#BFD3C1", "#A2C3A4", "#C4F1BE", "#FF7B9C", "#CEE5F2", "#FF7B9C","#CEE5F2")
names(palette) <- unique(fig_data$indicator_name)

scales <- list(
  fillcolor = list(palette = palette), 
  yaxis = list(limits = c(0, 1), nbreaks = 2, type = "percent", expand = c(0,0), droplines = FALSE)
)

legend <- list(
  show = TRUE, 
  direction = "vertical", 
  title = NULL, 
  nrows = 2, 
  ncols = 6, 
  reverse = FALSE
)

labels <- list(
  title = "Composition of MSEs in sample",
  subtitle =  "MSEs (%)",
  yax_ti = NULL,
  xax_ti = NULL,
   caption = paste(SOURCE, "Notes: MSEs correspond to businesses with 1-10 employees including the owner")
)

vars <- list(
  xvar = "group_cat_val", yvar = "mean", fillvar = "indicator_name"
)

facets <- list(
  type = "wrap", 
  wrap_nrows = 1,
  wrap_ncols = 5,
  rows = "indicator_group", 
  cols = "indicator_group", 
  scales = "fixed", 
  space = "free",
  drop_row_label = TRUE, 
  drop_col_label = FALSE, 
  add_dividers = FALSE
)


fig_flex(fig_data, vars, facets = facets, figparams, scales, legend, labels, coord_flip = TRUE) + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())

```

---

```{r, fig.width = 12, fig.asp = 0.65}
#| label: fig-mse_sector
#| echo: false
#| warning: false
#| fig-cap: "MSEs by sector of production"
#| cap-location: margin

indicators <- c("business_total")
groups_l1 <- "city"
groups_l2 <- GROUPS[c("business_sector_str")]

indicators <- c("business_sector_food")
groups <- GROUPS[c("city")]
ests <- compute_summary_mainlevel_1g(indicators, groups, data = main_data_all, weights = "weight_msme", psu = NULL, keep = NULL)


ests_men <- compute_summary_mainlevel_2g(indicators, groups_l1, groups_l2, data = main_data_all %>% filter(resp_sex_men == 1), weights = "weight_msme", psu = NULL, keep = "total") %>% mutate(subgroup = "Men")
ests_women <- compute_summary_mainlevel_2g(indicators, groups_l1, groups_l2, data = main_data_all %>% filter(resp_sex_women == 1), weights = "weight_msme", psu = NULL, keep = "total") %>% mutate(subgroup = "Women")


factor_params <- list(
  wrap_sizes = list(indicator_name = 80, indicator_group = 60, group_name = 25, group_cat_val = 80), 
  reverse_order = list(indicator_name = TRUE, indicator_group = TRUE, group_name = FALSE, group_cat_val = TRUE), 
  order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)

fig_data <- sample_sector_bycity(bind_rows(ests_men, ests_women), sector_agg0_to_agg3(main_data_all), round = 0) %>% 
  mutate(
    group_cat_val = as.character(group_cat_val), 
    group_cat_val = ifelse(group_cat_val == "Selling of food products for immediate consumption (street food seller, restaurants, catering)", "Selling of food products for immediate consumption", group_cat_val), 
    group_cat_val = ifelse(group_cat_val == "Manufacturing of food (including bakers, exclude restaurants, street food-sellers)", "Manufacturing of food", group_cat_val)
 ) %>% 
select(-indicator_group) %>% rename(indicator_group = business_sector_agg3) %>% filter(nobs >= 5)
fig_data <- prep_fig_data(fig_data, factor_params, include_valuelabel = FALSE) %>% 
  group_by(group_cat_val, subgroup) %>%
  mutate(
    mean_share = mean(share, na.rm = TRUE), 
    mean_share = ifelse(is.na(mean_share), 0, mean_share)
  ) %>% 
  group_by(subgroup) %>% 
  mutate(
    group_cat_val = fct_reorder(group_cat_val, mean_share)
  ) %>% ungroup() %>% 
  mutate(
    valuelabel = ifelse(share < 0.05, NA, valuelabel)
  )


labels <- list(
  title = "MSEs by sector of production",
  subtitle =  "MSEs (%)",
  yax_ti = NULL,
  xax_ti = NULL,
  caption = paste(SOURCE, "Notes: MSEs correspond to businesses with 1-10 employees including the owner")
)

figparams <- list(
  geom_type = "bar", # One of "bar" or "tile"
  bars = list(width = 0.9, position = "dodge", position_width = 0.9, color = "white", labeltotal = FALSE), 
  valuelabels = list(show = TRUE, lab_hjust = 0, lab_vjust = 0.5, lab_face = "plain", lab_size = 2.75),
  catlabels = list(show = FALSE), 
  errorbars = list(show = FALSE)
)

palette <- c("#41BBD9", "#CEE5F2", "#FF9F1C")
names(palette) <- c("Services: trade (re-sale)", "Services: other (eg. transport, construction)", "Manufacturing")

maxy <- roundupN(max(fig_data$share, na.rm = TRUE), 15)

scales <- list(
  fillcolor = list(palette = palette), 
  yaxis = list(limits = c(0, maxy), nbreaks = 2, type = "percent", expand = NULL, droplines = FALSE)
)

legend <- list(
  show = TRUE, 
  title = "", 
  nrows = 1, 
  ncols = 3, 
  reverse = TRUE
)

vars <- list(
  xvar = "group_cat_val", yvar = "share", fillvar = "indicator_group"
)

facets <- list(
  type = "grid", 
  rows = "subgroup", 
  cols = "city",
  nrows = 1, 
  ncols = 4,
  scales = "free", 
  space = "free", 
  drop_row_label = FALSE, 
  drop_col_label = FALSE, 
  add_dividers = FALSE
)

fig_flex(fig_data, vars, facets = facets, figparams, scales, legend, labels, coord_flip = TRUE) + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())

```

---

```{r, fig.width = 12, fig.asp = 0.45}
#| label: fig-mses_productivity
#| echo: false
#| warning: false
#| fig-cap: "MSE revenues and productivity"
#| cap-location: margin

# Firm performance: Monthly revenue and normalized sales per employee

fig_notes <- c("Notes: This figure is based on responses to the quesetion 'In [insert last calendar month], what were the total NET sales of this business?'. MSEs reported monthly revenue in local currency, these values are converted to current USD using June 1 2024 exchange rates obtained from UN treasury data and to international $ using purchasing power parity conversaion fators from the World Bank (WB) World Development Indicators database (WDI) [indicator code: PA.NUS.PPP]. Daily sales per employee is computed by standardizing revenues across firms using data on the months per year and the hours per week the business is in operation. GDP per person employed in constant 2021 PPP $ is provided as a benchamrk for comparison and is obtaind from the WB WDI database [indicator code: SL.GDP.PCAP.EM.KD].")

indicators <- c("perf_rev_reports", "perf_rev_usd", "perf_revpdypemp_usd",  "perf_rev_ppp", "perf_revpdypemp_ppp")
groups <- GROUPS[c("city")]

ests <- compute_summary_mainlevel_1g(indicators, groups, data = main_data_all, weights = "weight_msme", psu = NULL, keep = NULL)

factor_params <- list(
  wrap_sizes = list(indicator_name = 60, indicator_group = 30, group_name = 25, group_cat_val = NULL), 
  reverse_order = list(indicator_name = TRUE, indicator_group = FALSE, group_name = FALSE, group_cat_val = TRUE), 
  order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)

fig_data <- prep_fig_data(ests, factor_params, include_valuelabel = FALSE) %>% 
  mutate(
    mean = ifelse(indicator == "perf_rev_reports", mean*100, median), 
    mean_low = ifelse(indicator == "perf_rev_reports", mean_low*100, median_low), 
    mean_upp = ifelse(indicator == "perf_rev_reports", mean_upp*100, median_upp), 
    valuelabel = ifelse(indicator == "perf_rev_reports", paste0(pctclean(mean, 0), "%"), 
                        ifelse(str_detect(indicator, "perf_revphrpemp"), numclean(mean, 2), numclean(mean, 0))), 
    currency = ifelse(str_detect(indicator, "usd"), "Current USD", NA), 
    currency = ifelse(str_detect(indicator, "ppp"), "International $", currency), 
    currency = ifelse(is.na(currency), "Currency not applicable", currency), 
    indicator_name = str_trim(str_replace(indicator_name, "\\[USD\\]", "")), 
    indicator_name = str_trim(str_replace(indicator_name, "\\[International \\$\\]", "")), 
    indicator_name = fct_inorder(indicator_name)
    )

gdp_peremp <- wb_data(indicator = "SL.GDP.PCAP.EM.KD", country = COUNTRIES, return_wide = FALSE) %>% 
  select(country, year = date, gdp_pe_ppp = value) %>% 
  group_by(country) %>% 
  mutate(
    max_year = max(year), 
    gdp_pe_ppp_pd = gdp_pe_ppp/12/30.5
  ) %>% 
  filter(year == max_year) %>% 
  mutate(
    group_cat_val = CITIES[country], 
    indicator_name = "Daily sales per employee",
    mean = gdp_pe_ppp_pd, 
    currency = "International $"
    )
  
  
 labels <- list(
  title = "MSE revenues and productivity",
  subtitle = "Median monthly sales and standardized daily sales per worker",
  yax_ti = NULL,
  xax_ti = NULL,
  caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP)
)

figparams <- list(
  geom_type = "bar", # One of "bar" or "tile"
  bars = list(width = 0.8, position = "dodge", position_width = 0.9, labeltotal = FALSE, color = "white"), 
  valuelabels = list(show = TRUE, lab_hjust = 1, lab_ndgfcty = 70, lab_ndgdiry = -1, lab_ndgx = 0.5, lab_face = "plain", lab_size = 3.5), 
  catlabels = list(show = FALSE), 
  errorbars = list(show = FALSE, color = "#2374AB")
)

palette <- c("grey90", "#CEE5F2", "#41BBD9")
names(palette) <- unique(fig_data$currency)

scales <- list(
  fillcolor = list(palette = palette), 
  yaxis = list(limits = c(0, 1), nbreaks = 5, type = "number", expand = c(0.1,0.2), droplines = TRUE)
)

legend <- list(
  show = TRUE, 
  title = NULL, 
  nrows = 1, 
  ncols = 1, 
  reverse = FALSE
)

vars <- list(
  xvar = "group_cat_val", yvar = "mean", fillvar = "currency"
)

facets <- list(
  type = "wrap", 
  rows = "group_name", 
  nrows = 1, 
  ncols = 3,
  cols = "indicator_name", 
  scales = "free_x", 
  space = "free", 
  drop_row_label = FALSE, 
  drop_col_label = FALSE, 
  add_dividers = FALSE
)

fig_flex(fig_data, vars, facets, figparams, scales, legend, labels, coord_flip = TRUE) +
  geom_point(data = gdp_peremp, aes(x = group_cat_val, y = mean, color = "Reference: GDP per person employed, International $ (WDI)"), shape = 21, size = 2, stroke = 1.5, fill = "red") + 
  guides(color = guide_legend(title = NULL)) + 
  scale_color_manual(values = "#41BBD9")

```

---

```{r, fig.width = 12, fig.asp = 0.45}
#| label: fig-mse_perf_subj
#| echo: false
#| warning: false
#| fig-cap: "Changes in MSE outcomes in past year"
#| cap-location: margin

fig_notes <- c("Notes: The data in this figure is based on the firm owner or manager's own evaluation of changes in sales, the number of employees and investments compared to the same time 12 months ago.")

indicators <- c("perf_sales_up", "perf_sales_same", "perf_sales_down", "perf_emp_up", "perf_emp_same",  "perf_emp_down", "perf_investment", "perf_newservices", "perf_subj_growing", "perf_subj_static", "perf_subj_other")       

groups <- GROUPS[c("city")]

ests <- compute_summary_mainlevel_1g(indicators, groups, data = main_data_all, weights = "weight_msme", psu = NULL, keep = "mean")

factor_params <- list(
  wrap_sizes = list(indicator_name = 40, indicator_group = 40, group_name = 25, group_cat_val = NULL), 
  reverse_order = list(indicator_name = TRUE, indicator_group = FALSE, group_name = FALSE, group_cat_val = FALSE), 
  order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)

fig_data <- prep_fig_data(ests, factor_params)

labels <- list(
  title = "Changes in business outcomes in past year",
  subtitle =  "MSEs (%)",
  yax_ti = NULL,
  xax_ti = NULL,
  caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP)
)

figparams <- list(
  geom_type = "bar", # One of "bar" or "tile"
  bars = list(width = 0.9, color = "white", position = "dodge", fill = "#CEE5F2", position_width = 0.5, labeltotal = FALSE), 
  valuelabels = list(show = TRUE, lab_hjust = 0, lab_face = "plain", lab_size = 3.5),
  catlabels = list(show = FALSE), 
  errorbars = list(show = FALSE, color = "#2374AB")
)

scales <- list(
  fillcolor = list(palette = NULL), 
  yaxis = list(limits = c(0, 1), nbreaks = 2, type = "percent", expand = NULL, droplines = TRUE)
)

legend <- list(
  show = TRUE, 
  title = NULL, 
  nrows = 1, 
  ncols = 1, 
  reverse = FALSE
)

vars <- list(
  xvar = "indicator_name", yvar = "mean", fillvar = NULL
)

facets <- list(
  type = "grid", 
  rows = "indicator_group", 
  cols = "group_cat_val", 
  scales = "free_y", 
  space = "free", 
  drop_row_label = FALSE, 
  drop_col_label = FALSE, 
  add_dividers = FALSE
)

fig_flex(fig_data, vars, facets, figparams, scales, legend, labels, coord_flip = TRUE) + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())

```

## The small business owner 


```{r, fig.width = 12, fig.asp = 0.45}
#| label: fig-mse_owner_chars
#| echo: false
#| warning: false
#| fig-cap: "MSE owner characteristics"
#| cap-location: margin

indicators <- c("resp_education_agg4_shc_non", "resp_education_agg4_shc_pri", "resp_education_agg4_shc_sec", "resp_education_agg4_shc_trt", "resp_experience_agg5_shc_1", "resp_experience_agg5_shc_2_5", "resp_experience_agg5_shc_6_10", "resp_experience_agg5_shc_11_20", "resp_experience_agg5_shc_20", "resp_age_agg6_shc_25", "resp_age_agg6_shc_2535", "resp_age_agg6_shc_3545", "resp_age_agg6_shc_4555", "resp_age_agg6_shc_5565", "resp_age_agg6_shc_65")

groups <- GROUPS[c("city")]

ests <- compute_summary_mainlevel_1g(indicators, groups, data = main_data_all, weights = "weight_msme", psu = NULL, keep = "mean")

indicators <- c("resp_age", "resp_experience")
ref <- compute_summary_mainlevel_1g(indicators, groups, data = main_data_all, weights = "weight_msme", psu = NULL, keep = "mean")

factor_params <- list(
  wrap_sizes = list(indicator_name = 40, indicator_group = 40, group_name = 25, group_cat_val = NULL), 
  reverse_order = list(indicator_name = TRUE, indicator_group = FALSE, group_name = FALSE, group_cat_val = FALSE), 
  order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)

fig_data <- prep_fig_data(ests, factor_params)

labels <- list(
  title = "Age, education and experience of MSE owners or managers",
  subtitle =  "Owners or managers (%)",
  yax_ti = NULL,
  xax_ti = NULL,
  caption = SOURCE
)

figparams <- list(
  geom_type = "bar", # One of "bar" or "tile"
  bars = list(width = 0.9, color = "white", position = "dodge", fill = "#CEE5F2", position_width = 0.5, labeltotal = FALSE), 
  valuelabels = list(show = TRUE, lab_hjust = 0, lab_face = "plain", lab_size = 3.5),
  catlabels = list(show = FALSE), 
  errorbars = list(show = FALSE, color = "#2374AB")
)

scales <- list(
  fillcolor = list(palette = NULL), 
  yaxis = list(limits = c(0, 1), nbreaks = 2, type = "percent", expand = NULL, droplines = TRUE)
)

legend <- list(
  show = TRUE, 
  title = NULL, 
  nrows = 1, 
  ncols = 1, 
  reverse = FALSE
)

vars <- list(
  xvar = "indicator_name", yvar = "mean", fillvar = NULL
)

facets <- list(
  type = "grid", 
  rows = "indicator_group", 
  cols = "group_cat_val", 
  scales = "free_y", 
  space = "free", 
  drop_row_label = FALSE, 
  drop_col_label = FALSE, 
  add_dividers = FALSE
)

fig_flex(fig_data, vars, facets, figparams, scales, legend, labels, coord_flip = TRUE) + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())


```

---

```{r, fig.width = 12, fig.asp = 0.675}
#| label: fig-mse_owner_psych
#| echo: false
#| warning: false
#| fig-cap: "Pyschographic characrteristics of SME owners or managers, by gender"
#| cap-location: margin

 fig_notes <- c("Notes: Only owners were asked about the motivation for starting the business and the primary goal for the business over the next year. MSEs are classified into one of 3 'psychographic orientations' based on owner responses about motivations, goals and attitude to risk. 'Growth' oriented firms are those with owners who see themsevles as entreprenuers, want to grow the business over the next 12 months and who have a medium to high tolerance for risk. 'Survial' oriented firms are those whose owners started the business due to lack of opportunities or other reasons, whose main goal is to cover costs or leave the business and who have a medium to low tolerance for risk. 'Stability' firms are those who neither meet the criteria for 'Growth' or 'Survival'.")

indicators <- c("resp_motivation_entrep", "resp_motivation_lackopp", "resp_motivation_oth", 
                "resp_maingoal_grow",  "resp_maingoal_stab", "resp_maingoal_leave", 
                "resp_riskapproach_aggr", "resp_riskapproach_calc", "resp_riskapproach_avoid", 
                "resi_resp_attitude_chllng_1", "resi_resp_attitude_chllng_2", "resi_resp_attitude_chllng_3" , "resi_resp_attitude_chllng_4", "resp_psych_segment_shc_grow", "resp_psych_segment_shc_stab", "resp_psych_segment_shc_surv")

groups <- GROUPS[c("city")]

ests <- compute_summary_mainlevel_1g(indicators, groups, data = main_data_all, weights = "weight_msme", psu = NULL, keep = "mean")

factor_params <- list(
  wrap_sizes = list(indicator_name = 60, indicator_group = 30, group_name = 25, group_cat_val = NULL), 
  reverse_order = list(indicator_name = TRUE, indicator_group = FALSE, group_name = FALSE, group_cat_val = FALSE), 
  order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)

fig_data <- prep_fig_data(ests, factor_params)

labels <- list(
   title = "Pyschographic characteristics of SME owners or managers",
  subtitle = "% of MSE owners or managers",
  yax_ti = NULL,
  xax_ti = NULL,
  caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP)
)

figparams <- list(
  geom_type = "bar", # One of "bar" or "tile"
  bars = list(width = 0.8, position = "dodge", position_width = 0.9, labeltotal = FALSE, fill = "#CEE5F2", color = "white"), 
  valuelabels = list(show = TRUE, lab_hjust = 0, lab_face = "plain", lab_size = 3.5),
  catlabels = list(show = FALSE), 
  errorbars = list(show = FALSE, color = "#2374AB")
)

scales <- list(
  fillcolor = list(palette = NULL), 
  yaxis = list(limits = c(0, 1), nbreaks = 2, type = "percent", expand = NULL, droplines = TRUE)
)

legend <- list(
  show = TRUE, 
  title = NULL, 
  nrows = 1, 
  ncols = 1, 
  reverse = FALSE
)

vars <- list(
  xvar = "indicator_name", yvar = "mean", fillvar = NULL
)

facets <- list(
  type = "grid", 
  rows = "indicator_group", 
  cols = "group_cat_val", 
  scales = "free_y", 
  space = "free", 
  drop_row_label = FALSE, 
  drop_col_label = FALSE, 
  add_dividers = FALSE
)

fig_flex(fig_data, vars, facets, figparams, scales, legend, labels, coord_flip = TRUE) + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())


```

---

```{r, fig.width = 12, fig.asp = 0.5}
#| label: fig-reg_growth_gender
#| echo: false
#| warning: false
#| fig-cap: "Correlation between owner's motivations, goals and attitudes to risk"
#| cap-location: margin

fig_notes <- c("Notes: The results shown are based on a linear regression model that measures the effect of gender on several outcomes of interest. The 'unadjusted' model does not include any controls, while the 'adjusted' model includes controls for two variables: years of experience and educational attainment. The regression parameters are used to compute predicted probabilities for male and female business owners with the average years of experience running the business in the sample and with secondary-level educational attainment.")

# Defining regressions
  depvars <- c("resp_motivation_entrep", "resp_maingoal_grow", "resp_riskapproach_aggr", "resp_psych_segment_shc_grow")
  depvar_labels <- c("Identifies as an entrepreneur", "Main goal is to grow the business", "Approach to risk is aggressive ", "Growth and risk oriented")
  names(depvar_labels) <- depvars
  maineffects <- "resp_sex_women"
  effect_labels <- c("(Intercept)" = "Men", INDICATORS[maineffects])
  confounds <- c("resp_experience_c", "resp_education_agg4_shc_non", "resp_education_agg4_shc_pri", "resp_education_agg4_shc_trt")
  
combinations <- expand.grid(depvars, COUNTRIES, stringsAsFactors = FALSE)
depvars <- combinations[[1]]
countries <- combinations[[2]]
  
# Running regressions
ests <- bind_rows(
    #map(depvars, model_and_prepfig, maineffects, confounds = NULL, data = main_data_all, depvar_labels, effect_labels),
    map2(depvars, countries, model_and_prepfig, maineffect = maineffects, confounds = confounds, data = main_data_all, depvar_labels = depvar_labels, effect_labels = effect_labels)
  ) %>% mutate(effect_label = str_replace(effect_label, "Gender: ", ""))

factor_params <- list(
  wrap_sizes = list(depvar_label = 20, effect_label = 15, model_type = 25), 
  reverse_order = list(depvar_label = TRUE, effect_label = TRUE, model_type = FALSE), 
  order_vars = list(depvar_label = NULL, effect_label = NULL, model_type = NULL)
)

fig_data <- prep_reg_data(prep_reg_factors(ests, factor_params, include_valuelabel = FALSE))

labels <- list(
      title = "Observational estimates of the relationship of MSE owner's gender on growth orientation and risk-taking",
      subtitle = "",
      y = "Predicted probability (%)",
      x = NULL,
      caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP*1.1)
    )

  barparams <- list(
  bars = list(width = 0.6, color = "grey90"), 
  valuelabels = list(show = FALSE, lab_vjust = 0, lab_hjust = 0, lab_ndgy = 0, lab_ndgx = 0.25, lab_face = "plain", lab_size = 3), 
  arrowlabels = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0.5, lab_ndgy = 0, lab_ndgx = -0.35,  lab_face = "plain", lab_size = 3), 
  baselinelabel = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0, lab_ndgy = 0, lab_ndgx = 0,  lab_face = "bold", lab_size = 3)
) 

scales <- list(
  y = list(limits = c(0,1), nbreaks = 2, position = "left"), 
  x = list(position = "bottom")
)

 facets <- list(type = "grid", cols ="depvar_label", rows = "city", scales = "free", space = "free", drop_row_label = FALSE) 
    
 fig_regests(fig_data, labels, facets = facets, barparams, scales, effect_desc = "The difference (in percentage points) between women and men owners on motivation, goals and approach to risk", coord_flip = TRUE)


```

## Digital technology 

```{r, fig.width = 12, fig.asp = 0.55}
#| label: fig-digtech_overview
#| echo: false
#| warning: false
#| fig-cap: "Access to connectivity and devices"
#| cap-location: margin

fig_notes <- "Notes: The digital technology adoption score is a score that counts how many digital technologies are in use by the firm, the score ranges from 0 (no digiital technologies used) to 10 (all ten digital technologies labeled in the figure used)."

indicators <- c("tech_has_device", "tech_has_internet", "tech_uses_website", names(main_data_all)[str_detect(names(main_data_all), "^(tech.+).(shc.+)$")], "tech_uses_ai", "tech_uses_digpayments", "tech_uses_digloans", "tech_uses_adoption_score")
indicators <- indicators[!str_detect(indicators, "NA")]
groups_l1 <- "city"
groups_l2 <- GROUPS[c("resp_sex_str")]

# Adjustment to data
main_data_all <- main_data_all %>% 
  mutate(
    tech_uses_messaging_shc_nam = ifelse(country == "Ethiopia" & is.na(tech_uses_messaging_shc_nam), 0, tech_uses_messaging_shc_nam), 
    tech_uses_socialmedia_shc_nam = ifelse(country == "Ethiopia" & is.na(tech_uses_socialmedia_shc_nam), 0, tech_uses_socialmedia_shc_nam), 
    tech_uses_software_shc_mol = ifelse(country == "Ethiopia" & is.na(tech_uses_software_shc_mol), 0, tech_uses_software_shc_mol), 
     tech_uses_software_shc_nam = ifelse(country %in% c("Ethiopia", "Nigeria") & is.na(tech_uses_software_shc_nam), 0, tech_uses_software_shc_nam), 
    )

ests <- compute_summary_mainlevel_2g(indicators, groups_l1, groups_l2, data = main_data_all, weights = "weight_msme", psu = NULL, keep = "mean")

factor_params <- list(
  wrap_sizes = list(indicator_name = 80, indicator_group = 50, group_name = 25, group_cat_val = 20), 
  reverse_order = list(indicator_name = TRUE, indicator_group = FALSE, group_name = FALSE, group_cat_val = FALSE), 
  order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)

fig_data <- prep_fig_data(ests, factor_params)
fig_data <- tech_adoption_landscape(fig_data, wrap = factor_params[["wrap_sizes"]][["indicator_name"]])

labels <- list(
  title = "Adoption and frequency of use of digital technologies",
  subtitle =  "MSEs (%)",
  yax_ti = NULL,
  xax_ti = NULL,
  caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP)
)

figparams <- list(
  geom_type = "tile", # One of "bar" or "tile"
  tiles = list(color = "white"), 
  valuelabels = list(show = TRUE, lab_hjust = 0.5, lab_face = "plain", lab_size = 3.5),
  catlabels = list(show = FALSE), 
  errorbars = list(show = FALSE)
)

scales <- list(
  fillcolor = list(palette = "identity", direction = NULL), 
  yaxis = list(limits = c(0, 1), nbreaks = 5, type = "percent", expand = NULL, droplines = TRUE)
)

legend <- list(
  show = FALSE, 
  title = NULL, 
  nrows = 1, 
  ncols = 1, 
  reverse = FALSE
)

vars <- list(
  xvar = "indicator_name", yvar = "group_cat_val", fillvar = "fillcolor"
)

facets <- list(
  type = "grid", 
  rows = "indicator_group", 
  cols = "city", 
  scales = "free", 
  space = "free",
  drop_row_label = FALSE, 
  drop_col_label = FALSE, 
  add_dividers = FALSE
)

fig_flex(fig_data %>% filter(indicator_name != "Never used"), vars, facets, figparams, scales, legend, labels, coord_flip = TRUE) 

```

---

```{r, fig.width = 12, fig.asp = 0.5}
#| label: fig-reg_digtech_drivers
#| echo: false
#| warning: false
#| fig-cap: "Drivers of overall technology adoption"
#| cap-location: margin

fig_notes <- "Notes: The results shown are based on a linear regression model that measures the relationship of several owner and firm-level characteristics with digital technology adoption measured using a score that ranges from 0 to 10 depending on the firm's use of ten distinct technologies. The regression parameters are used to compute predicted probabilities to show the marginal effect of each characteristic on digital technology adoption. Age and experience are mean centered and the effect shown corresponds to an increase in 5 years. The height of 'Baseline' corresponds to the predicted digital technology adoption score for firms run by an owner with mean age, mean experience, with primary-level or less educaitonal attainment and in the retail trade (services) sector."
  
# Defining regressions
  depvars <- c("tech_uses_adoption_score")
  depvar_labels <- INDICATORS[depvars]
  maineffects <- c("resp_sex_women", "resp_age_c_5yi", "resp_experience_c_5yi", "resp_education_agg2_shc_secormore", "resp_motivation_entrep", "resp_maingoal_grow", "resp_riskapproach_aggr", "business_sector_agg3_shc_srv_oth", "business_sector_agg3_shc_mfc")
  effect_labels <- c("(Intercept)" = "Baseline", INDICATORS[maineffects])
  
combinations <- expand.grid(depvars, COUNTRIES, stringsAsFactors = FALSE)
depvars <- combinations[[1]]
countries <- combinations[[2]]
  
# Running regressions
ests <- bind_rows(
    #map(depvars, model_and_prepfig, maineffects, confounds = NULL, data = main_data_all, depvar_labels, effect_labels),
    map2(depvars, countries, model_and_prepfig, maineffect = maineffects, confounds = NULL, data = main_data_all, depvar_labels = depvar_labels, effect_labels = effect_labels)
  )

# Preparing figure data
factor_params <- list(
  wrap_sizes = list(depvar_label = 20, effect_label = 55, model_type = 25), 
  reverse_order = list(depvar_label = TRUE, effect_label = TRUE, model_type = FALSE), 
  order_vars = list(depvar_label = NULL, effect_label = NULL, model_type = NULL)
)

fig_data <- prep_reg_data(prep_reg_factors(ests, factor_params, include_valuelabel = FALSE))

 labels <- list(
      title = "Predictors of overall technology adoption",
      subtitle = "",
      y = "Predicted technology adoption score [0-10]",
      x = NULL,
      caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP*1.2)
    )
 
 barparams <- list(
  bars = list(width = 0.6, color = "grey90"), 
  valuelabels = list(show = FALSE, lab_vjust = 0, lab_hjust = 0, lab_ndgy = 0, lab_ndgx = 0.25, lab_face = "plain", lab_size = 3), 
  arrowlabels = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0.5, lab_ndgy = 0, lab_ndgx = -0.25,  lab_face = "plain", lab_size = 3), 
  baselinelabel = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0, lab_ndgy = 0, lab_ndgx = 0,  lab_face = "bold", lab_size = 3.5)
) 

scales <- list(
  y = list(position = "right", nbreaks = 2), 
  x = list(txtwrap = 50, position = "bottom")
)

facets <- list(type = "grid", cols ="city", rows = "depvar_label", scales = "free", space = "fixed", drop_row_label = TRUE) 
    
fig_regests(fig_data, labels, facets = facets, barparams, scales, effect_desc = "The effect of each predictor on technology adoption", coord_flip = TRUE) 


```

---

```{r, fig.width = 12, fig.asp = 0.425}
#| label: fig-digtech_usecases
#| echo: false
#| warning: false
#| fig-cap: "Applications of digital technology"
#| cap-location: margin

fig_notes <- "Notes: The functional use-case categories are defined as follows: 'Communicating with customers' includes use of messaging (e.g. Whatsapp) or social media apps (e.g. Facebook); 'Accessing markets' includes use of e-commerce platforms (e.g. Amazon) or a dedicated business website; 'Enterprise operations' includes use of digital applications or software (e.g. for booking, inventory management), including aritifical intelligence; 'Digital payment acceptance' includes use of any in-store POS device that accepts digital customer payments (credit or debit cards, mobile money, QR codes), or online payments. The frequency of use of digital payments acceptance is not available, and corresponds to whether the business has used any means of digital payment acceptance in the past 12 months."

#indicators <- c("tech_cat_none", "tech_uses_messaging", "tech_uses_socialmedia", "tech_uses_website", "tech_uses_ecommerce", "tech_uses_software", "tech_uses_ai", "tech_uses_digpayments", "tech_uses_digloans")

indicators <- c("tech_function_comms_30da", "tech_function_mkts_30da", "tech_function_ops_30da", "tech_function_epay", "tech_function_epay_expos")

groups <- GROUPS[c("city")]

ests <- compute_summary_mainlevel_1g(indicators, groups, data = main_data_all, weights = "weight_msme", psu = NULL, keep = "mean")

factor_params <- list(
  wrap_sizes = list(indicator_name = 60, indicator_group = 40, group_name = 25, group_cat_val = NULL), 
  reverse_order = list(indicator_name = TRUE, indicator_group = FALSE, group_name = FALSE, group_cat_val = FALSE), 
  order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)

fig_data <- prep_fig_data(ests, factor_params)

labels <- list(
  title = "Applications of digital technologies used by MSEs",
  subtitle =  "MSEs (%)",
  yax_ti = NULL,
  xax_ti = NULL,
  caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP)
)

figparams <- list(
  geom_type = "bar", # One of "bar" or "tile"
  bars = list(width = 0.8, position = "dodge", position_width = 0.9, labeltotal = FALSE, color = "white"), 
  valuelabels = list(show = TRUE, lab_hjust = 0, lab_face = "plain", lab_size = 3.5),
  catlabels = list(show = FALSE), 
  errorbars = list(show = FALSE, color = "#2374AB")
)

palette <- c("#A2C3A4", "#C4F1BE", "#FF9F1C")
names(palette) <- c("Uses", "30-day active", "7-day active")   

scales <- list(
  fillcolor = list(palette = palette), 
  yaxis = list(limits = c(0, 1.18), nbreaks = 5, type = "percent", expand = NULL, droplines = FALSE)
)

legend <- list(
  show = TRUE, 
  title = NULL, 
  nrows = 1, 
  ncols = 1, 
  reverse = FALSE
)

vars <- list(
  xvar = "indicator_group", yvar = "mean", fillvar = "indicator_name"
)

facets <- list(
  type = "grid", 
  rows = "indicator_group", 
  cols = "group_cat_val", 
  scales = "free", 
  space = "free", 
  drop_row_label = TRUE, 
  drop_col_label = FALSE, 
  add_dividers = FALSE
)

fig_flex(fig_data, vars, facets, figparams, scales, legend, labels, coord_flip = TRUE) + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())


```

---

```{r, fig.width = 12, fig.asp = 0.4}
#| label: fig-digtech_use_depth
#| echo: false
#| warning: false
#| fig-cap: "Depth of digital technology adoption"
#| cap-location: margin

fig_notes <- "Notes: Four use-cases of digital technology are considered here: 'Communicating with customers', 'Accessing markets', 'Enterprise operations' and 'Digital payment acceptance'. MSEs are classified with respect to whether they use digital technology for any one, any two, any three or all four, or none of these use-cases."

indicators <- c("tech_cat_none", "tech_cat_any1", "tech_cat_any2", "tech_cat_any3all4")
groups <- GROUPS[c("city")]

groups_l1 <- "city"
groups_l2 <- GROUPS[c("resp_sex_str")]

ests <- compute_summary_mainlevel_2g(indicators, groups_l1, groups_l2, data = main_data_all, weights = "weight_msme", psu = NULL, keep = "mean")

factor_params <- list(
  wrap_sizes = list(indicator_name = 60, indicator_group = 40, group_name = 25, group_cat_val = NULL), 
  reverse_order = list(indicator_name = TRUE, indicator_group = FALSE, group_name = FALSE, group_cat_val = FALSE), 
  order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)

fig_data <- prep_fig_data(ests, factor_params) %>% mutate(valuelabel = ifelse(mean < 0.01, NA, valuelabel))

labels <- list(
  title = "Breadth of digital applications used by MSEs",
  subtitle =  "MSEs (%)",
  yax_ti = NULL,
  xax_ti = NULL,
  caption =  str_wrap(paste(SOURCE, fig_notes), CAP_WRAP)
)

figparams <- list(
  geom_type = "bar", # One of "bar" or "tile"
  bars = list(width = 0.8, position = "dodge", position_width = 0.9, labeltotal = FALSE, color = "white"), 
  valuelabels = list(show = TRUE, lab_hjust = 0, lab_face = "plain", lab_size = 3),
  catlabels = list(show = FALSE), 
  errorbars = list(show = FALSE, color = "#2374AB")
)

palette <- c("#FF7B9C", "#CEE5F2")
names(palette) <- c("Women", "Men")   

maxy <- roundupN(max(fig_data$mean, na.rm = TRUE), n =10)

scales <- list(
  fillcolor = list(palette = palette), 
  yaxis = list(limits = c(0, maxy), nbreaks = 5, type = "percent", expand = NULL, droplines = FALSE)
)

legend <- list(
  show = TRUE, 
  title = NULL, 
  nrows = 1, 
  ncols = 1, 
  reverse = FALSE
)

vars <- list(
  xvar = "indicator_name", yvar = "mean", fillvar = "group_cat_val"
)

facets <- list(
  type = "grid", 
  rows = "indicator_group", 
  cols = "city", 
  scales = "free", 
  space = "free", 
  drop_row_label = TRUE, 
  drop_col_label = FALSE, 
  add_dividers = FALSE
)

fig_flex(fig_data, vars, facets, figparams, scales, legend, labels, coord_flip = TRUE) + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())


```

--- 

```{r, fig.width = 12, fig.asp = 0.625}
#| label: fig-tech_adoptionfactors
#| echo: false
#| warning: false
#| fig-cap: "Non-financial digital technology adoption factors"
#| cap-location: margin

fig_notes <- "Notes: The data in this figure pertains to the following 3 questions:(1) What are the factors that encouraged you to adopt and actively use the digital technologies you indicated before? (2) What benefits has the use of digital technologies had on your business? (3) What are the main challenges the business has faced in using digital technologies?. These survey questions were only asked to businesses who reported using any of the following non-financial digital technologies: messaging apps, social media, e-commerce platforms, software for business operations, a website or artificial intelligence."

indicators <- c(names(main_data_all)[str_detect(names(main_data_all), "adopfactors")],
                names(main_data_all)[str_detect(names(main_data_all), "adopbenefits")], 
                names(main_data_all)[str_detect(names(main_data_all), "adopchllng")])

groups_l1 <- "city"
groups_l2 <- GROUPS[c("resp_sex_str")]

ests <- compute_summary_mainlevel_2g(indicators, groups_l1, groups_l2, data = main_data_all, weights = "weight_msme", psu = NULL, keep = "mean")

factor_params <- list(
  wrap_sizes = list(indicator_name = 60, indicator_group = 40, group_name = 25, group_cat_val = NULL), 
  reverse_order = list(indicator_name = TRUE, indicator_group = FALSE, group_name = FALSE, group_cat_val = FALSE), 
  order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)

fig_data <- prep_fig_data(ests, factor_params)

labels <- list(
  title = "Non-financial digital technology adoption factors, benefits and challenges",
  subtitle =  "MSEs using digital solutions (%)",
  yax_ti = NULL,
  xax_ti = NULL,
  caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP)
)

figparams <- list(
  geom_type = "bar", # One of "bar" or "tile"
  bars = list(width = 0.8, position = "dodge", position_width = 0.9, labeltotal = FALSE, color = "white"), 
  valuelabels = list(show = FALSE, lab_hjust = 0, lab_face = "plain", lab_size = 3.5),
  catlabels = list(show = FALSE), 
  errorbars = list(show = FALSE, color = "#2374AB")
)

palette <- c("#FF7B9C", "#CEE5F2")
names(palette) <- c("Women", "Men")   

scales <- list(
  fillcolor = list(palette = palette), 
  yaxis = list(limits = c(0, 1), nbreaks = 4, type = "percent", expand = NULL, droplines = TRUE)
)

legend <- list(
  show = TRUE, 
  title = NULL, 
  nrows = 1, 
  ncols = 1, 
  reverse = FALSE
)

vars <- list(
  xvar = "indicator_name", yvar = "mean", fillvar = "group_cat_val"
)

facets <- list(
  type = "grid", 
  rows = "indicator_group", 
  cols = "city", 
  scales = "free", 
  space = "free", 
  drop_row_label = FALSE, 
  drop_col_label = FALSE, 
  add_dividers = TRUE
)

fig_flex(fig_data, vars, facets, figparams, scales, legend, labels, coord_flip = TRUE) + theme(axis.text.x = element_text(size = 9))

```

---

```{r, fig.width = 12, fig.asp = 0.4}
#| label: fig-reg_revprhr_internet
#| echo: false
#| warning: false
#| fig-cap: "Relationship between internet-connectivity and firm-level labor productivity"
#| cap-location: margin

fig_notes <- "Notes: The results shown are based on a linear regression model that measures the effect of digital technology adoption on firm labor productivity. The model includes controls for two variables: years of experience and educational attainment. The regression parameters are used to compute predicted probabilities to show the marginal effect of internet connectivity on productivity. The height of 'Baseline' corresponds to the predicted productivity for firms run by an owner with mean years of experience, and secondary-level educaitonal attainment."
  
# Defining regressions
  depvars <- c("perf_revpdypemp_ppp_log")
  depvar_labels <- INDICATORS[depvars]
  maineffects <- c("tech_has_internet")
  effect_labels <- c("(Intercept)" = "No internet connection", INDICATORS[maineffects])
  confounds <- c("resp_experience_c", "resp_education_agg4_shc_non", "resp_education_agg4_shc_pri",  "resp_education_agg4_shc_trt")
  
combinations <- expand.grid(depvars, COUNTRIES, stringsAsFactors = FALSE)
depvars <- combinations[[1]]
countries <- combinations[[2]]

# Running regressions
ests <- bind_rows(
    map2(depvars, countries, model_and_prepfig, maineffect = maineffects, confounds = confounds, data = main_data_all, depvar_labels = depvar_labels, effect_labels = effect_labels, depvarlog = TRUE)
  ) %>% mutate(effect_label = str_replace(effect_label, ": Has", ""))
    
factor_params <- list(
  wrap_sizes = list(depvar_label = 20, effect_label = 10, model_type = 25), 
  reverse_order = list(depvar_label = FALSE, effect_label = TRUE, model_type = FALSE), 
  order_vars = list(depvar_label = NULL, effect_label = NULL, model_type = NULL)
)

fig_data <- prep_reg_data(prep_reg_factors(ests, factor_params, include_valuelabel = FALSE), depvarlog = TRUE) %>% 
  mutate(depvar_label = "Predicted daily sales\nper worker (Current USD)")

 labels <- list(
      title = "Observational estimates of the effect of internet connectivity on labor productivity",
      subtitle = "", 
      y = "Predicted daily sales per employee (PPP)",
      x = NULL,
      caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP*1.2)
    )

  barparams <- list(
  bars = list(width = 0.6, color = "grey90"), 
  valuelabels = list(show = FALSE, lab_vjust = 0, lab_hjust = 0, lab_ndgy = 0, lab_ndgx = 0.25, lab_face = "plain", lab_size = 3), 
  arrowlabels = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0.5, lab_ndgy = 0, lab_ndgx = -0.15,  lab_face = "plain", lab_size = 3),
  baselinelabel = list(show = TRUE, lab_vjust = 0, lab_hjust = 0.5, lab_ndgy = 0, lab_ndgx = 0,  lab_face = "bold", lab_size = 3.5)
) 


miny <- round(min(fig_data$fig_data), 2) 
maxy <- round(max(fig_data$fig_data), 2) 
buffer <- (maxy - miny)/100
miny <- miny - buffer*2
if (miny > 0) { miny <- 0 }
maxy <- maxy + buffer*2

scales <- list(
  y = list(limits = NULL, position = "left", nbreaks = 3), 
  x = list(position = "bottom")
)

 facets <- list(type = "wrap", 
                rows ="city", 
                cols = "city", 
                scales = "free_x", 
                space = "free", 
                drop_row_label = FALSE) 
    
 fig_regests(fig_data, labels, facets = facets, barparams, scales, effect_desc = "The effect of an internet connection on labor productivity", coord_flip = TRUE)

```

--- 

```{r, fig.width = 12, fig.asp = 0.4}
#| label: fig-reg_revprhr_digitaladoption
#| echo: false
#| warning: false
#| fig-cap: "Relationship between digital technology and firm-level labor productivity"
#| cap-location: margin

fig_notes <- "Notes: The results shown are based on a linear regression model that measures the effect of general digital technology adoption on firm labor productivity. The model includes controls for two variables: years of experience and educational attainment. The regression parameters are used to compute predicted probabilities to show the marginal effect of digital technology on productivity. The height of 'Baseline' corresponds to the predicted productivity for firms run by an owner with mean years of experience, and secondary-level educaitonal attainment."
  
# Defining regressions
  depvars <- c("perf_revpdypemp_ppp_log")
  depvar_labels <- INDICATORS[depvars]
  maineffects <- c("tech_uses_adoption_score_c")
  effect_labels <- c("(Intercept)" = "Baseline", INDICATORS[maineffects])
  confounds <- c("resp_experience_c", "resp_education_agg4_shc_non", "resp_education_agg4_shc_pri",  "resp_education_agg4_shc_trt")
  confounds2 <- c("resp_experience_c", "resp_education_agg4_shc_non", "resp_education_agg4_shc_pri",  "resp_education_agg4_shc_trt", "psych_mca_dim1", "psych_mca_dim2")
  
combinations <- expand.grid(depvars, COUNTRIES, stringsAsFactors = FALSE)
depvars <- combinations[[1]]
countries <- combinations[[2]]

# Running regressions
ests <- bind_rows(
    map2(depvars, countries, model_and_prepfig, maineffect = maineffects, confounds = confounds, data = main_data_all, depvar_labels = depvar_labels, effect_labels = effect_labels, depvarlog = TRUE)
  ) %>% mutate(effect_label = str_replace(effect_label, ": Has", ""))
    
factor_params <- list(
  wrap_sizes = list(depvar_label = 40, effect_label = 10, model_type = 25), 
  reverse_order = list(depvar_label = TRUE, effect_label = TRUE, model_type = FALSE), 
  order_vars = list(depvar_label = NULL, effect_label = NULL, model_type = NULL)
)

fig_data <- prep_reg_data(prep_reg_factors(ests, factor_params, include_valuelabel = FALSE), depvarlog = TRUE) %>% 
  mutate(depvar_label = "Predicted daily sales\nper worker (Current USD)")

 labels <- list(
      title = "Observational estimates of the effect of general digital technology adoption on labor productivity",
      subtitle = "", 
      y = "Predicted daily sales per employee (PPP)",
      x = NULL,
      caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP*1.2)
    )

  barparams <- list(
  bars = list(width = 0.6, color = "grey90"), 
  valuelabels = list(show = FALSE, lab_vjust = 0, lab_hjust = 0, lab_ndgy = 0, lab_ndgx = 0.25, lab_face = "plain", lab_size = 3), 
  arrowlabels = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0.5, lab_ndgy = 0, lab_ndgx = -0.15,  lab_face = "plain", lab_size = 3),
  baselinelabel = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0, lab_ndgy = 0, lab_ndgx = 0,  lab_face = "bold", lab_size = 3.5)
) 


miny <- round(min(fig_data$fig_data), 2) 
maxy <- round(max(fig_data$fig_data), 2) 
buffer <- (maxy - miny)/100
miny <- miny - buffer*2
if (miny > 0) { miny <- 0 }
maxy <- maxy + buffer*2

scales <- list(
  y = list(limits = NULL, position = "left", nbreaks = 3), 
  x = list(position = "bottom")
)

 facets <- list(type = "wrap", 
                rows ="city", 
                cols = "city", 
                scales = "free_x", 
                space = "free", 
                drop_row_label = FALSE) 
    
 fig_regests(fig_data, labels, facets = facets, barparams, scales, effect_desc = "The effect of digital adoption on labor productivity", coord_flip = TRUE)


```

--- 

```{r, fig.width = 12, fig.asp = 0.5}
#| label: fig-reg_growth_digtech
#| echo: false
#| warning: false
#| fig-cap: "Relationship between general digital technology adoption and subjective growth"
#| cap-location: margin

fig_notes <- "Notes: The results shown are based on a linear regression model that measures the effect of financial services on subjective evaluations of firm growth. Here, firm growth is a binary variable with a value of 1 corresponding to firms whose owners report having either grown revenues or the number of employees in the past 1 year and 0 if otherwise. The model includes controls for two variables: years of experience and educational attainment. The regression parameters are used to compute predicted probabilities to show the marginal effect of digital technology adoption on firm growth The height of 'Baseline' corresponds to the predicted productivity for firms run by an owner with mean years of experience, and secondary-level educaitonal attainment."
  
# Defining regressions
  depvars <- c("perf_growth_subj_any")
  depvar_labels <- INDICATORS[depvars]
  maineffects <- c("tech_uses_adoption_score_c")
  effect_labels <- c("(Intercept)" = "Baseline", INDICATORS[maineffects])
  confounds <- c("resp_experience_c", "resp_education_agg4_shc_non", "resp_education_agg4_shc_pri",  "resp_education_agg4_shc_trt")

combinations <- expand.grid(depvars, COUNTRIES, stringsAsFactors = FALSE)
depvars <- combinations[[1]]
countries <- combinations[[2]]

# Running regressions
ests <- bind_rows(
  map2(depvars, countries, model_and_prepfig, maineffect = maineffects, confounds = confounds, data = main_data_all, depvar_labels = depvar_labels, effect_labels = effect_labels, depvarlog = FALSE)
  )

factor_params <- list(
  wrap_sizes = list(depvar_label = 20, effect_label = 20, model_type = 25), 
  reverse_order = list(depvar_label = TRUE, effect_label = FALSE, model_type = FALSE), 
  order_vars = list(depvar_label = NULL, effect_label = NULL, model_type = NULL)
)

fig_data <- prep_reg_data(prep_reg_factors(ests, factor_params, include_valuelabel = FALSE), depvarlog = FALSE, b_round = 2) %>% 
  mutate(depvar_label = "Predicted growth score (%)")

 labels <- list(
      title = "Observational estimates of the effect of general technology adoption on subjective evaluations of firm growth",
      subtitle = "", 
      y = "Predicted probability of growth (%)",
      x = NULL,
      caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP*1.2)
    )

  barparams <- list(
  bars = list(width = 0.6, color = "grey90"), 
  valuelabels = list(show = FALSE, lab_vjust = 0, lab_hjust = 0, lab_ndgy = 0, lab_ndgx = 0.25, lab_face = "plain", lab_size = 3), 
  arrowlabels = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0.5, lab_ndgy = 0, lab_ndgx = -0.15,  lab_face = "plain", lab_size = 3),
  baselinelabel = list(show = TRUE, lab_vjust = 0, lab_hjust = 0.5, lab_ndgy = 0, lab_ndgx = 0,  lab_face = "bold", lab_size = 3.5)
) 


miny <- round(min(fig_data$fig_data), 2) 
maxy <- round(max(fig_data$fig_data), 2) 
buffer <- (maxy - miny)/100
miny <- miny - buffer*2
if (miny > 0) { miny <- 0 }
maxy <- maxy + buffer*2

scales <- list(
  y = list(limits = c(miny,maxy), position = "left", nbreaks = 3), 
  x = list(position = "bottom")
)

 facets <- list(type = "grid", rows ="depvar_label", cols = "city", scales = "free", space = "free", drop_row_label = TRUE) 
    
 fig_regests(fig_data, labels, facets = facets, barparams, scales, effect_desc = "The effect of digital technology adoption on probability of firm growth (percentage points)", coord_flip = FALSE)


```

--- 

```{r, fig.width = 12, fig.asp = 0.45}
#| label: fig-reg_revprhr_digtechusecase
#| echo: false
#| warning: false
#| fig-cap: "Relationship between digital technology adoption and firm-level labor productivity"
#| cap-location: margin

fig_notes <- "Notes: The results shown are based on a linear regression model that measures the effect of digital technology adoption on firm labor productivity. This model includes controls for two variables: years of experience and educational attainment. The regression parameters are used to compute predicted probabilities to show the marginal effect of digital technology adoption on productivity. The height of 'Baseline' corresponds to the predicted productivity for firms run by an owner with mean years of experience, and secondary-level educaitonal attainment."

# Defining regressions
  depvars <- c("perf_revpdypemp_ppp_log")
  depvar_labels <- INDICATORS[depvars]
  maineffects <- c("tech_function_comms", "tech_function_mkts","tech_function_ops","tech_function_epay")
  effect_labels <- c("(Intercept)" = "No digital solutions used", INDICATORS[maineffects])
  confounds <- c("resp_experience_c", "resp_education_agg4_shc_non", "resp_education_agg4_shc_pri",  "resp_education_agg4_shc_trt")
    confounds2 <- c("resp_experience_c", "resp_education_agg4_shc_non", "resp_education_agg4_shc_pri",  "resp_education_agg4_shc_trt", "psych_mca_dim1", "psych_mca_dim2")
  
combinations <- expand.grid(depvars, COUNTRIES, stringsAsFactors = FALSE)
depvars <- combinations[[1]]
countries <- combinations[[2]]
  
# Running regressions
ests <- bind_rows(
    map2(depvars, countries, model_and_prepfig, maineffect = maineffects, confounds = confounds, data = main_data_all, depvar_labels = depvar_labels, effect_labels = effect_labels, depvarlog = TRUE)
  )

factor_params <- list(
  wrap_sizes = list(depvar_label = 25, effect_label = 70, model_type = 25), 
  reverse_order = list(depvar_label = TRUE, effect_label = TRUE, model_type = FALSE), 
  order_vars = list(depvar_label = NULL, effect_label = NULL, model_type = NULL)
)

fig_data <- prep_reg_data(prep_reg_factors(ests, factor_params, include_valuelabel = FALSE), depvarlog = TRUE) %>%
 mutate(effect_label = str_replace(effect_label, ": Uses", ""))

 labels <- list(
      title = "Observational estimates of the effect of digital technology adoption on labor productivity",
      subtitle = "",
      y = "Predicted daily sales per worker (International $)",
      x = NULL,
      caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP*1.2)
    )

barparams <- list(
  bars = list(width = 0.6, color = "grey90"), 
  valuelabels = list(show = FALSE, lab_vjust = 0, lab_hjust = 0, lab_ndgy = 0, lab_ndgx = 0.25, lab_face = "plain", lab_size = 3), 
  arrowlabels = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0.5, lab_ndgy = 0, lab_ndgx = -0.25,  lab_face = "plain", lab_size = 3), 
  baselinelabel = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0, lab_ndgy = 0.01, lab_ndgx = 0,  lab_face = "bold", lab_size = 3.5)
) 


miny <- round(min(fig_data$fig_data), 2) 
maxy <- round(max(fig_data$fig_data), 2) 
buffer <- (maxy - miny)/100
miny <- miny - buffer*2
if (miny > 0) { miny <- 0 }
maxy <- maxy + buffer*2

scales <- list(
  y = list(limits = NULL, position = "left", nbreaks = 2), 
  x = list(position = "bottom")
)

 facets <- list(type = "wrap", 
                rows ="city", 
                cols = "city", 
                scales = "free_x", 
                space = "free", 
                drop_row_label = TRUE) 
    
 fig_regests(fig_data, labels, facets = facets, barparams, scales, effect_desc = "The effect of digital technology adoption on labor productivity", coord_flip = TRUE)


```

--- 


```{r, fig.width = 12, fig.asp = 0.45}
#| label: fig-reg_revprhr_digtechdepth
#| echo: false
#| warning: false
#| fig-cap: "Relationship between depth of digital technology adoption and firm-level labor productivity"
#| cap-location: margin

fig_notes <- "Notes: The results shown are based on a linear regression model that measures the effect of combined use of digital technology applications on firm labor productivity. This model includes controls for two variables: years of experience and educational attainment of the owner or manager of the firm. The regression parameters are used to compute predicted probabilities to show the marginal effect of digital technology adoption on productivity. The height of 'Baseline' corresponds to the predicted productivity for firms run by an owner with mean years of experience, and secondary-level educaitonal attainment."

# Defining regressions
  depvars <- c("perf_revpdypemp_ppp_log")
  depvar_labels <- INDICATORS[depvars]
  maineffects <- c("tech_cat_any1", "tech_cat_any2", "tech_cat_any3all4")
  effect_labels <- c("(Intercept)" = "No digital solutions used", INDICATORS[maineffects])
  confounds <- c("resp_experience_c", "resp_education_agg4_shc_non", "resp_education_agg4_shc_pri",  "resp_education_agg4_shc_trt", "resp_maingoal_grow", "resp_riskapproach_aggr")
  confounds2 <- c("resp_experience_c", "resp_education_agg4_shc_non", "resp_education_agg4_shc_pri",  "resp_education_agg4_shc_trt", "psych_mca_dim1", "psych_mca_dim2")
  
combinations <- expand.grid(depvars, COUNTRIES, stringsAsFactors = FALSE)
depvars <- combinations[[1]]
countries <- combinations[[2]]
  
# Running regressions
ests <- bind_rows(
    #map(depvars, model_and_prepfig, maineffects, confounds = NULL, data = main_data_all, depvar_labels, effect_labels),
    map2(depvars, countries, model_and_prepfig, maineffect = maineffects, confounds = confounds, data = main_data_all, depvar_labels = depvar_labels, effect_labels = effect_labels,  depvarlog = TRUE)
  )

factor_params <- list(
  wrap_sizes = list(depvar_label = 60, effect_label = 70, model_type = 25), 
  reverse_order = list(depvar_label = TRUE, effect_label = TRUE, model_type = FALSE), 
  order_vars = list(depvar_label = NULL, effect_label = NULL, model_type = NULL)
)

fig_data <- prep_reg_data(prep_reg_factors(ests, factor_params, include_valuelabel = FALSE),  depvarlog = TRUE) %>% 
  mutate(effect_label = str_replace(effect_label, "Digital technology adoption: ", ""))


 labels <- list(
      title = "Observational estimates of the effect of the breadth of digital technology adoption on labor productivity",
      subtitle = "",
       y = "Predicted daily sales per worker (International $)",
      x = NULL,
      caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP*1.2)
    )

barparams <- list(
  bars = list(width = 0.6, color = "grey90"), 
  valuelabels = list(show = FALSE, lab_vjust = 0, lab_hjust = 0, lab_ndgy = 0, lab_ndgx = 0.25, lab_face = "plain", lab_size = 3), 
  arrowlabels = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0.5, lab_ndgy = 0, lab_ndgx = -0.15,  lab_face = "plain", lab_size = 3), 
  baselinelabel = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0, lab_ndgy = 0.01, lab_ndgx = 0,  lab_face = "bold", lab_size = 3.5)
) 

 facets <- list(type = "wrap", 
                rows ="city", 
                cols = "city", 
                scales = "free_x", 
                space = "free", 
                drop_row_label = FALSE) 

  miny <- round(min(fig_data$fig_data), 2) 
  maxy <- round(max(fig_data$fig_data), 2) 
  buffer <- (maxy - miny)/100
  miny <- miny - buffer*4
  if (miny > 0) { miny <- 0 }
  maxy <- maxy + buffer*4

scales <- list(
  y = list(limits = NULL, position = "left", nbreaks = 3), 
  x = list(position = "bottom")
)

 fig_regests(fig_data, labels, facets = facets, barparams, scales, effect_desc = "The effect of digital technology adoption on labor productivity", coord_flip = TRUE)
 
```

## Financial services 

```{r, fig.width = 12, fig.asp = 0.55}
#| label: fig-account_ownership
#| echo: false
#| warning: false
#| fig-cap: "Financical accounts and savings"
#| cap-location: margin

fig_notes <- c("Notes: Business savings account types are based on responses to the following question: Where are the business savings primarily kept? Common responses under other include: 'At home', 'Don't have savings' or saving with relatives, friends or neighbors. Savings account transaction channels are based on the following question: What are the options for transacting with this savings account? OTC represents 'Over the counter' and corresponds to the response option 'In-person through a physical branch location'.")

indicators <- c("fin_account_formal", "fin_owner_save", names(main_data_all)[str_detect(names(main_data_all), "bus_savings")])
groups_l1 <- "city"
groups_l2 <- GROUPS[c("resp_sex_str")]

ests <- compute_summary_mainlevel_2g(indicators, groups_l1, groups_l2, data = main_data_all, weights = "weight_msme", psu = NULL, keep = "mean")

factor_params <- list(
  wrap_sizes = list(indicator_name = 45, indicator_group = 20, group_name = 25, group_cat_val = NULL), 
  reverse_order = list(indicator_name = TRUE, indicator_group = FALSE, group_name = FALSE, group_cat_val = FALSE), 
  order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)

fig_data <- prep_fig_data(ests, factor_params)

labels <- list(
  title = "Account ownership and business savings",
  subtitle =  "MSEs (%)",
  yax_ti = NULL,
  xax_ti = NULL,
  caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP)
)

figparams <- list(
  geom_type = "bar", # One of "bar" or "tile"
  bars = list(width = 0.8, position = "dodge", position_width = 0.9, labeltotal = FALSE, color = "white"), 
  valuelabels = list(show = FALSE, lab_hjust = 0, lab_face = "plain", lab_size = 3.5),
  catlabels = list(show = FALSE), 
  errorbars = list(show = FALSE, color = "#2374AB")
)

palette <- c("#FF7B9C", "#CEE5F2")
names(palette) <- c("Women", "Men")     

scales <- list(
  fillcolor = list(palette = palette), 
  yaxis = list(limits = c(0, 1), nbreaks = 4, type = "percent", expand = NULL, droplines = TRUE)
)

legend <- list(
  show = TRUE, 
  title = NULL, 
  nrows = 1, 
  ncols = 1, 
  reverse = FALSE
)

vars <- list(
  xvar = "indicator_name", yvar = "mean", fillvar = "group_cat_val"
)

facets <- list(
  type = "grid", 
  rows = "indicator_group", 
  cols = "city", 
  scales = "free_y", 
  space = "free", 
  drop_row_label = FALSE, 
  drop_col_label = FALSE, 
  add_dividers = TRUE
)

fig_flex(fig_data, vars, facets, figparams, scales, legend, labels, coord_flip = TRUE) + theme(axis.text.x = element_text(size = 9))


```

--- 

```{r, fig.width = 12, fig.asp = 0.4}
#| label: fig-payments
#| echo: false
#| warning: false
#| fig-cap: "Merchant payments"
#| cap-location: margin

fig_notes <- c("Notes: The data in this question correspond to responses to the question 'In the last 12 months, what methods has the business used to accept payments from customers?'")

indicators <- c(names(main_data_all)[str_detect(names(main_data_all), "merchpay")])

groups_l1 <- "city"
groups_l2 <- GROUPS[c("resp_sex_str")]

ests <- compute_summary_mainlevel_2g(indicators, groups_l1, groups_l2, data = main_data_all, weights = "weight_msme", psu = NULL, keep = "mean")

factor_params <- list(
  wrap_sizes = list(indicator_name = 50, indicator_group = 25, group_name = 25, group_cat_val = NULL), 
  reverse_order = list(indicator_name = TRUE, indicator_group = FALSE, group_name = FALSE, group_cat_val = FALSE), 
  order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)

fig_data <- prep_fig_data(ests, factor_params)

labels <- list(
  title = "Merchant payments: Methods used by business to accept customer payments",
  subtitle =  "MSEs (%)",
  yax_ti = NULL,
  xax_ti = NULL,
  caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP)
)

figparams <- list(
  geom_type = "bar", # One of "bar" or "tile"
  bars = list(width = 0.8, position = "dodge", position_width = 0.9, labeltotal = FALSE, color = "white"), 
  valuelabels = list(show = FALSE, lab_hjust = 0, lab_face = "plain", lab_size = 3.5),
  catlabels = list(show = FALSE), 
  errorbars = list(show = FALSE, color = "#2374AB")
)

palette <- c("#FF7B9C", "#CEE5F2")
names(palette) <- c("Women", "Men")   

scales <- list(
  fillcolor = list(palette = palette), 
  yaxis = list(limits = c(0,1), nbreaks = 5, type = "percent", expand = NULL, droplines = TRUE)
)

legend <- list(
  show = TRUE, 
  title = NULL, 
  nrows = 1, 
  ncols = 1, 
  reverse = FALSE
)

vars <- list(
  xvar = "indicator_name", yvar = "mean", fillvar = "group_cat_val"
)

facets <- list(
  type = "grid", 
  rows = "indicator_group", 
  cols = "city", 
  scales = "free_y", 
  space = "free", 
  drop_row_label = TRUE, 
  drop_col_label = FALSE, 
  add_dividers = TRUE
)

fig_flex(fig_data, vars, facets, figparams, scales, legend, labels, coord_flip = TRUE) + theme(axis.text.x = element_text(size = 9))

```

---

```{r, fig.width = 12, fig.asp = 0.5}
#| label: fig-credit_demand
#| echo: false
#| warning: false
#| fig-cap: "Demand for credit"
#| cap-location: margin

fig_notes <- c("Notes: 'Used a loan or tried to obtain one in past 12 months' indicates whether the MSE had actively used a loan in the past 12 months OR tried to obtain a loan but coud not get one. The reasons for using credit are based on the following 'How did this business use the loans that were active in the last 12 months?', the reported percentages are for the subset of firms that had an active loan in the past 12 months")

indicators <- names(main_data_all)[str_detect(names(main_data_all), "activeloan_agg|activeloan_use")]
indicators <- indicators[!str_detect(indicators, "da")]
indicators <- c("fin_demandloan", "fin_activeloan_da_any", indicators) 

groups_l1 <- "city"
groups_l2 <- GROUPS[c("resp_sex_str")]

ests <- compute_summary_mainlevel_2g(indicators, groups_l1, groups_l2, data = main_data_all, weights = "weight_msme", psu = NULL, keep = "mean")

factor_params <- list(
  wrap_sizes = list(indicator_name = 60, indicator_group = 25, group_name = 25, group_cat_val = NULL), 
  reverse_order = list(indicator_name = TRUE, indicator_group = FALSE, group_name = FALSE, group_cat_val = FALSE), 
  order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)

fig_data <- prep_fig_data(ests, factor_params)

labels <- list(
  title = "Demand for credit and usage of loans (past 12 months)",
  subtitle =  "MSEs (%)",
  yax_ti = NULL,
  xax_ti = NULL,
  caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP)
)

figparams <- list(
  geom_type = "bar", # One of "bar" or "tile"
  bars = list(width = 0.8, position = "dodge", position_width = 0.9, labeltotal = FALSE, color = "white"), 
  valuelabels = list(show = FALSE, lab_hjust = 0, lab_face = "plain", lab_size = 3.5),
  catlabels = list(show = FALSE), 
  errorbars = list(show = FALSE, color = "#2374AB")
)

palette <- c("grey70", "#A2C3A4", "#C4F1BE", "#FF7B9C", "#CEE5F2")
names(palette) <- c("All businesses", "1 person", "2-10 people", "Women", "Men")   

maxy <- roundupN(max(fig_data$mean, na.rm = TRUE))

scales <- list(
  fillcolor = list(palette = palette), 
  yaxis = list(limits = c(0, 1), nbreaks = 4, type = "percent", expand = NULL, droplines = TRUE)
)

legend <- list(
  show = TRUE, 
  title = NULL, 
  nrows = 1, 
  ncols = 1, 
  reverse = FALSE
)

vars <- list(
  xvar = "indicator_name", yvar = "mean", fillvar = "group_cat_val"
)

facets <- list(
  type = "grid", 
  rows = "indicator_group", 
  cols = "city", 
  scales = "free_y", 
  space = "free", 
  drop_row_label = FALSE, 
  drop_col_label = FALSE, 
  add_dividers = TRUE
)

fig_flex(fig_data, vars, facets, figparams, scales, legend, labels, coord_flip = TRUE) + theme(axis.text.x = element_text(size = 9))


```

---

```{r, fig.width = 12, fig.asp = 0.4}
#| label: fig-credit_denied
#| echo: false
#| warning: false
#| fig-cap: "Barriers to credit"
#| cap-location: margin

fig_notes <- "Notes: The reported percentages associated with 'Reason could not get loan' are among the subset of firms that were denied a loan in the past 12 months"

indicators <- c(names(main_data_all)[str_detect(names(main_data_all), "denied")])

groups_l1 <- "city"
groups_l2 <- GROUPS[c("resp_sex_str")]

ests <- compute_summary_mainlevel_2g(indicators, groups_l1, groups_l2, data = main_data_all, weights = "weight_msme", psu = NULL, keep = "mean")

factor_params <- list(
  wrap_sizes = list(indicator_name = 60, indicator_group = 25, group_name = 25, group_cat_val = NULL), 
  reverse_order = list(indicator_name = TRUE, indicator_group = FALSE, group_name = FALSE, group_cat_val = FALSE), 
  order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)

fig_data <- prep_fig_data(ests, factor_params)

labels <- list(
  title = "Barriers to credit",
  subtitle =  "MSEs (%)",
  yax_ti = NULL,
  xax_ti = NULL,
  caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP)
)

figparams <- list(
  geom_type = "bar", # One of "bar" or "tile"
  bars = list(width = 0.8, position = "dodge", position_width = 0.9, labeltotal = FALSE, color = "white"), 
  valuelabels = list(show = FALSE, lab_hjust = 0, lab_face = "plain", lab_size = 3.5),
  catlabels = list(show = FALSE), 
  errorbars = list(show = FALSE, color = "#2374AB")
)

palette <- c("grey70", "#A2C3A4", "#C4F1BE", "#FF7B9C", "#CEE5F2")
names(palette) <- c("All businesses", "1 person", "2-10 people", "Women", "Men")   

maxy <- roundupN(max(fig_data$mean, na.rm = TRUE), 10)

scales <- list(
  fillcolor = list(palette = palette), 
  yaxis = list(limits = c(0, maxy), nbreaks = 4, type = "percent", expand = NULL, droplines = TRUE)
)

legend <- list(
  show = TRUE, 
  title = NULL, 
  nrows = 1, 
  ncols = 1, 
  reverse = FALSE
)

vars <- list(
  xvar = "indicator_name", yvar = "mean", fillvar = "group_cat_val"
)

facets <- list(
  type = "grid", 
  rows = "indicator_group", 
  cols = "city", 
  scales = "free_y", 
  space = "free", 
  drop_row_label = FALSE, 
  drop_col_label = FALSE, 
  add_dividers = TRUE
)

fig_flex(fig_data, vars, facets, figparams, scales, legend, labels, coord_flip = TRUE) + theme(axis.text.x = element_text(size = 9))

```

--- 

```{r, fig.width = 12, fig.asp = 0.55}
#| label: fig-dfs_impacts
#| echo: false
#| warning: false
#| fig-cap: "Impacts of digital financial services"
#| cap-location: margin

fig_notes <- "Notes: This figure shows responses to two questions asked to users of digital financial services (including savings, loans, payments and insurance): (1) What effects has the use of financial services used through a phone, app, or computer on your business? (2) What are the main challenges the business has faced in using financial services used through a phone, app, or computer on your business?"
  
indicators <- c("fin_dfs_user", names(main_data_all)[str_detect(names(main_data_all), "digital_benefits|digital_challenges")])

groups_l1 <- "city"
groups_l2 <- GROUPS[c("resp_sex_str")]

ests <- compute_summary_mainlevel_2g(indicators, groups_l1, groups_l2, data = main_data_all, weights = "weight_msme", psu = NULL, keep = "mean")

factor_params <- list(
  wrap_sizes = list(indicator_name = 60, indicator_group = 25, group_name = 25, group_cat_val = NULL), 
  reverse_order = list(indicator_name = TRUE, indicator_group = FALSE, group_name = FALSE, group_cat_val = FALSE), 
  order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)

fig_data <- prep_fig_data(ests, factor_params)

labels <- list(
  title = "Benefits and challenges of digital financial services",
  subtitle =  "MSEs (%)",
  yax_ti = NULL,
  xax_ti = NULL,
  caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP)
)

figparams <- list(
  geom_type = "bar", # One of "bar" or "tile"
  bars = list(width = 0.8, position = "dodge", position_width = 0.9, labeltotal = FALSE, color = "white"), 
  valuelabels = list(show = FALSE, lab_hjust = 0, lab_face = "plain", lab_size = 3.5),
  catlabels = list(show = FALSE), 
  errorbars = list(show = FALSE, color = "#2374AB")
)

palette <- c("grey70", "#A2C3A4", "#C4F1BE", "#FF7B9C", "#CEE5F2")
names(palette) <- c("All businesses", "1 person", "2-10 people", "Women", "Men")   

maxy <- roundupN(max(fig_data$mean, na.rm = TRUE))

scales <- list(
  fillcolor = list(palette = palette), 
  yaxis = list(limits = c(0, maxy), nbreaks = 4, type = "percent", expand = NULL, droplines = TRUE)
)

legend <- list(
  show = TRUE, 
  title = NULL, 
  nrows = 1, 
  ncols = 1, 
  reverse = FALSE
)

vars <- list(
  xvar = "indicator_name", yvar = "mean", fillvar = "group_cat_val"
)

facets <- list(
  type = "grid", 
  rows = "indicator_group", 
  cols = "city", 
  scales = "free_y", 
  space = "free", 
  drop_row_label = FALSE, 
  drop_col_label = FALSE, 
  add_dividers = TRUE
)

fig_flex(fig_data, vars, facets, figparams, scales, legend, labels, coord_flip = TRUE) + theme(axis.text.x = element_text(size = 9))


```

---

```{r, fig.width = 12, fig.asp = 0.4}
#| label: fig-ins
#| echo: false
#| warning: false
#| fig-cap: "Insurance usage"
#| cap-location: margin

fig_notes <- c("")

indicators <- c("fin_insur_lif_shc_cu" , "fin_insur_hlt_shc_cu", "fin_insur_acc_shc_cu", "fin_insur_bus_shc_cu", "fin_insur_aut_shc_cu", "fin_insur_any_shc_cu_comp")

groups_l1 <- "city"
groups_l2 <- GROUPS[c("resp_sex_str")]

ests <- compute_summary_mainlevel_2g(indicators, groups_l1, groups_l2, data = main_data_all, weights = "weight_msme", psu = NULL, keep = "mean")

factor_params <- list(
  wrap_sizes = list(indicator_name = 60, indicator_group = 25, group_name = 25, group_cat_val = NULL), 
  reverse_order = list(indicator_name = TRUE, indicator_group = FALSE, group_name = FALSE, group_cat_val = FALSE), 
  order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)

fig_data <- prep_fig_data(ests, factor_params)

labels <- list(
  title = "Adoption of insurance",
  subtitle =  "MSE owners or managers (%)",
  yax_ti = NULL,
  xax_ti = NULL,
  caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP)
)

figparams <- list(
  geom_type = "bar", # One of "bar" or "tile"
  bars = list(width = 0.8, position = "dodge", position_width = 0.9, labeltotal = FALSE, color = "white"), 
  valuelabels = list(show = FALSE, lab_hjust = 0, lab_face = "plain", lab_size = 3.5),
  catlabels = list(show = FALSE), 
  errorbars = list(show = FALSE, color = "#2374AB")
)

palette <- c("grey70", "#A2C3A4", "#C4F1BE", "#FF7B9C", "#CEE5F2")
names(palette) <- c("All businesses", "1 person", "2-10 people", "Women", "Men")   

maxy <- roundupN(max(fig_data$mean, na.rm = TRUE), 10)

scales <- list(
  fillcolor = list(palette = palette), 
  yaxis = list(limits = c(0, maxy), nbreaks = 4, type = "percent", expand = NULL, droplines = TRUE)
)

legend <- list(
  show = TRUE, 
  title = NULL, 
  nrows = 1, 
  ncols = 1, 
  reverse = FALSE
)

vars <- list(
  xvar = "indicator_group", yvar = "mean", fillvar = "group_cat_val"
)

facets <- list(
  type = "grid", 
  rows = "indicator_name", 
  cols = "city", 
  scales = "free_y", 
  space = "free", 
  drop_row_label = TRUE, 
  drop_col_label = FALSE, 
  add_dividers = TRUE
)

fig_flex(fig_data, vars, facets = facets, figparams, scales, legend, labels, coord_flip = TRUE) + theme(axis.text.x = element_text(size = 9))

```

---

```{r, fig.width = 12, fig.asp = 0.45}
#| label: fig-reg_revprhr_finserv
#| echo: false
#| warning: false
#| fig-cap: "Relationship between financial services and firm-level labor productivity"
#| cap-location: margin

fig_notes <- "Notes: The results shown are based on a linear regression model that measures the effect of financial services on firm-level labor productivity This model controls for experience, education and psychological characteristics of the owner related to motivation, growth orientation and risk tolerance. The regression parameters are used to compute predicted probabilities to show the marginal effect of financial services on productivity. The height of 'Baseline' corresponds to the predicted productivity for firms run by an owner with mean years of experience, and secondary-level educaitonal attainment."
  
# Defining regressions
  depvars <- c("perf_revpdypemp_ppp_log")
  depvar_labels <- INDICATORS[depvars]
  maineffects <- c("fin_account_formal", "fin_activeloan_agg_any", "fin_insur_any_shc_cu")
  effect_labels <- c("(Intercept)" = "Baseline: No account, loan or insurance used", INDICATORS[maineffects])
  confounds <- c("resp_experience_c", "resp_education_agg4_shc_non", "resp_education_agg4_shc_pri",  "resp_education_agg4_shc_trt")

combinations <- expand.grid(depvars, COUNTRIES, stringsAsFactors = FALSE)
depvars <- combinations[[1]]
countries <- combinations[[2]]

# Running regressions
ests <- bind_rows(
  map2(depvars, countries, model_and_prepfig, maineffect = maineffects, confounds = confounds, data = main_data_all, depvar_labels = depvar_labels, effect_labels = effect_labels, depvarlog = TRUE)
  )

factor_params <- list(
  wrap_sizes = list(depvar_label = 20, effect_label = 35, model_type = 25), 
  reverse_order = list(depvar_label = TRUE, effect_label = TRUE, model_type = FALSE), 
  order_vars = list(depvar_label = NULL, effect_label = NULL, model_type = NULL)
)

fig_data <- prep_reg_data(prep_reg_factors(ests, factor_params, include_valuelabel = FALSE), depvarlog = TRUE) %>% 
  mutate(depvar_label = "Predicted probability of\n access to emergency funds (%)")

 labels <- list(
      title = "Observational estimates of the effect of financial services on firm productivity",
      subtitle = "", 
      y = "Predicted daily sales per employee (PPP)",
      x = NULL,
      caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP*1.2)
    )

  barparams <- list(
  bars = list(width = 0.6, color = "grey90"), 
  valuelabels = list(show = FALSE, lab_vjust = 0, lab_hjust = 0, lab_ndgy = 0, lab_ndgx = 0.25, lab_face = "plain", lab_size = 3), 
  arrowlabels = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0.5, lab_ndgy = 0, lab_ndgx = -0.15,  lab_face = "plain", lab_size = 3),
  baselinelabel = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0, lab_ndgy = 0, lab_ndgx = 0,  lab_face = "bold", lab_size = 3.5)
) 


miny <- round(min(fig_data$fig_data), 2) 
maxy <- round(max(fig_data$fig_data), 2) 
buffer <- (maxy - miny)/100
miny <- miny - buffer*2
if (miny > 0) { miny <- 0 }
maxy <- maxy + buffer*2

scales <- list(
  y = list(position = "left", nbreaks = 3), 
  x = list(position = "bottom")
)

 facets <- list(type = "wrap", rows = "city", cols = "city", scales = "free_x", space = "free", drop_row_label = TRUE) 
    
 fig_regests(fig_data, labels, facets = facets, barparams, scales, effect_desc = "The effect of financial service use on labor productivity", coord_flip = TRUE)


```

---

```{r, fig.width = 12, fig.asp = 0.45}
#| label: fig-reg_resilience_finserv
#| echo: false
#| warning: false
#| fig-cap: "Relationship between financial services and financial resilience"
#| cap-location: margin

fig_notes <- "Notes: The results shown are based on a linear regression model that measures the effect of financial services on financial resilience. Financial resilience is defined as firms that would not have major difficulty raising emergency funds equivalent to 1 month of revenue in 7 days. This model includes controls for two variables: years of experience and educational attainment. The regression parameters are used to compute predicted probabilities to show the marginal effect of digital technology adoption on productivity. The height of 'Baseline' corresponds to the predicted productivity for firms run by an owner with mean years of experience, and secondary-level educaitonal attainment."
  
# Defining regressions
  depvars <- c("resi_capital_financial")
  depvar_labels <- INDICATORS[depvars]
  maineffects <- c("fin_account_formal", "fin_activeloan_agg_any", "fin_insur_any_shc_cu")
  effect_labels <- c("(Intercept)" = "Baseline: No account, loans or insurance used", INDICATORS[maineffects])
  confounds <- c("resp_experience_c", "resp_education_agg4_shc_non", "resp_education_agg4_shc_pri",  "resp_education_agg4_shc_trt")

combinations <- expand.grid(depvars, COUNTRIES, stringsAsFactors = FALSE)
depvars <- combinations[[1]]
countries <- combinations[[2]]

# Running regressions
ests <- bind_rows(
  map2(depvars, countries, model_and_prepfig, maineffect = maineffects, confounds = confounds, data = main_data_all, depvar_labels = depvar_labels, effect_labels = effect_labels, depvarlog = FALSE)
  )

factor_params <- list(
  wrap_sizes = list(depvar_label = 20, effect_label = 35, model_type = 25), 
  reverse_order = list(depvar_label = TRUE, effect_label = TRUE, model_type = FALSE), 
  order_vars = list(depvar_label = NULL, effect_label = NULL, model_type = NULL)
)

fig_data <- prep_reg_data(prep_reg_factors(ests, factor_params, include_valuelabel = FALSE), depvarlog = FALSE) %>% 
  mutate(depvar_label = "Predicted probability of\n access to emergency funds (%)")

 labels <- list(
      title = "Observational estimates of the effect of financial services on financial resilience",
      subtitle = "", 
      y = "Predicted probability of access to emergency funds (%)",
      x = NULL,
      caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP*1.2)
    )

  barparams <- list(
  bars = list(width = 0.6, color = "grey90"), 
  valuelabels = list(show = FALSE, lab_vjust = 0, lab_hjust = 0, lab_ndgy = 0, lab_ndgx = 0.25, lab_face = "plain", lab_size = 3), 
  arrowlabels = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0.5, lab_ndgy = 0, lab_ndgx = -0.25,  lab_face = "plain", lab_size = 3),
  baselinelabel = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0, lab_ndgy = 0, lab_ndgx = 0,  lab_face = "bold", lab_size = 3.5)
) 

scales <- list(
  y = list(limits = c(0, 1), position = "left", nbreaks = 3), 
  x = list(position = "bottom")
)

 facets <- list(type = "grid", rows ="depvar_label", cols = "city", scales = "free", space = "free", drop_row_label = TRUE) 
    
 fig_regests(fig_data, labels, facets = facets, barparams, scales, effect_desc = "The effect of digital technology on the probability of financial resilience (percentage points)", coord_flip = TRUE)


```

```{r, fig.width = 12, fig.asp = 0.45}
#| label: fig-reg_growth_finserv
#| echo: false
#| warning: false
#| fig-cap: "Relationship between financial services and firm growth"
#| cap-location: margin

fig_notes <- "Notes: The results shown are based on a linear regression model that measures the effect of financial services on financial resilience. This model includes controls for two variables: years of experience and educational attainment. The regression parameters are used to compute predicted probabilities to show the marginal effect of digital technology adoption on productivity. The height of 'Baseline' corresponds to the predicted productivity for firms run by an owner with mean years of experience, and secondary-level educaitonal attainment."
  
# Defining regressions
  depvars <- c("perf_growth_subj_any")
  depvar_labels <- INDICATORS[depvars]
  maineffects <- c("fin_account_formal", "fin_activeloan_agg_any", "fin_insur_any_shc_cu")
  effect_labels <- c("(Intercept)" = "Baseline: No financial services used", INDICATORS[maineffects])
  confounds <- c("resp_experience_c", "resp_education_agg4_shc_non", "resp_education_agg4_shc_pri",  "resp_education_agg4_shc_trt")

combinations <- expand.grid(depvars, COUNTRIES, stringsAsFactors = FALSE)
depvars <- combinations[[1]]
countries <- combinations[[2]]

# Running regressions
ests <- bind_rows(
  map2(depvars, countries, model_and_prepfig, maineffect = maineffects, confounds = confounds, data = main_data_all, depvar_labels = depvar_labels, effect_labels = effect_labels, depvarlog = FALSE)
  )

factor_params <- list(
  wrap_sizes = list(depvar_label = 20, effect_label = 35, model_type = 25), 
  reverse_order = list(depvar_label = TRUE, effect_label = TRUE, model_type = FALSE), 
  order_vars = list(depvar_label = NULL, effect_label = NULL, model_type = NULL)
)

fig_data <- prep_reg_data(prep_reg_factors(ests, factor_params, include_valuelabel = FALSE), depvarlog = FALSE) %>% 
  mutate(depvar_label = "Predicted growth score (%)")

 labels <- list(
      title = "Observational estimates of the effect of general technology adoption on subjective evaluations of firm growth",
      subtitle = "", 
      y = "Predicted probability of growth (%)",
      x = NULL,
      caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP*1.2)
    )

  barparams <- list(
  bars = list(width = 0.6, color = "grey90"), 
  valuelabels = list(show = FALSE, lab_vjust = 0, lab_hjust = 0, lab_ndgy = 0, lab_ndgx = 0.25, lab_face = "plain", lab_size = 3), 
  arrowlabels = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0.5, lab_ndgy = 0, lab_ndgx = -0.25,  lab_face = "plain", lab_size = 3),
  baselinelabel = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0, lab_ndgy = 0, lab_ndgx = 0,  lab_face = "bold", lab_size = 3.5)
) 


scales <- list(
  y = list(limits = NULL, position = "left", nbreaks = 3), 
  x = list(position = "bottom")
)

 facets <- list(type = "wrap", rows ="city", cols = "city", scales = "free_x", space = "free", drop_row_label = TRUE) 
    
 fig_regests(fig_data, labels, facets = facets, barparams, scales, effect_desc = "The effect of digital technology adoption on labor productivity", coord_flip = TRUE)


```
```{r, fig.width = 12, fig.asp = 0.45}
#| label: fig-reg_capex_finserv
#| echo: false
#| warning: false
#| fig-cap: "Relationship between financial services and capital investment"
#| cap-location: margin

fig_notes <- "Notes: The results shown are based on a linear regression model that measures the effect of financial services on financial resilience. This model includes controls for two variables: years of experience and educational attainment. The regression parameters are used to compute predicted probabilities to show the marginal effect of digital technology adoption on productivity. The height of 'Baseline' corresponds to the predicted productivity for firms run by an owner with mean years of experience, and secondary-level educaitonal attainment."
  
# Defining regressions
  depvars <- c("perf_investment")
  depvar_labels <- INDICATORS[depvars]
  maineffects <- c("fin_account_formal", "fin_activeloan_agg_any", "fin_insur_any_shc_cu")
  effect_labels <- c("(Intercept)" = "Baseline: No financial services used", INDICATORS[maineffects])
  confounds <- c("resp_experience_c", "resp_education_agg4_shc_non", "resp_education_agg4_shc_pri",  "resp_education_agg4_shc_trt")

combinations <- expand.grid(depvars, COUNTRIES, stringsAsFactors = FALSE)
depvars <- combinations[[1]]
countries <- combinations[[2]]

# Running regressions
ests <- bind_rows(
  map2(depvars, countries, model_and_prepfig, maineffect = maineffects, confounds = confounds, data = main_data_all, depvar_labels = depvar_labels, effect_labels = effect_labels, depvarlog = FALSE)
  )

factor_params <- list(
  wrap_sizes = list(depvar_label = 20, effect_label = 35, model_type = 25), 
  reverse_order = list(depvar_label = TRUE, effect_label = TRUE, model_type = FALSE), 
  order_vars = list(depvar_label = NULL, effect_label = NULL, model_type = NULL)
)

fig_data <- prep_reg_data(prep_reg_factors(ests, factor_params, include_valuelabel = FALSE), depvarlog = FALSE) %>% 
  mutate(depvar_label = "Predicted growth score (%)")

 labels <- list(
      title = "Observational estimates of the effect of financial services on capital investment",
      subtitle = "", 
      y = "Predicted probability of investment in past 1 year (%)",
      x = NULL,
      caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP*1.2)
    )

  barparams <- list(
  bars = list(width = 0.6, color = "grey90"), 
  valuelabels = list(show = FALSE, lab_vjust = 0, lab_hjust = 0, lab_ndgy = 0, lab_ndgx = 0.25, lab_face = "plain", lab_size = 3), 
  arrowlabels = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0.5, lab_ndgy = 0, lab_ndgx = -0.25,  lab_face = "plain", lab_size = 3),
  baselinelabel = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0, lab_ndgy = 0, lab_ndgx = 0,  lab_face = "bold", lab_size = 3.5)
) 


scales <- list(
  y = list(limits = NULL, position = "left", nbreaks = 3), 
  x = list(position = "bottom")
)

 facets <- list(type = "wrap", rows ="city", cols = "city", scales = "free_x", space = "free", drop_row_label = TRUE) 
    
 fig_regests(fig_data, labels, facets = facets, barparams, scales, effect_desc = "The effect of digital technology adoption on labor productivity", coord_flip = TRUE)


```

## Consumer protection

```{r, fig.width = 12, fig.asp = 0.4}
#| label: fig-cp_loanrepayment
#| echo: false
#| warning: false
#| fig-cap: "Challenges with loan repayment"
#| cap-location: margin

fig_notes <- "Notes: The two questions on loan repayment difficulty were only asked to MSEs that had an active loan in the past 12 months, the questions are: (1) In the last 12 months, has the business been unable to pay a full loan installment on-time for any funds that it borrowed? and (2) How did you cope with this difficulty to repay?"
  
indicators <- c(names(main_data_all)[str_detect(names(main_data_all), "loanrepaydiff")])

groups_l1 <- "city"
groups_l2 <- GROUPS[c("fullsample")]

ests <- compute_summary_mainlevel_2g(indicators, groups_l1, groups_l2, data = main_data_all, weights = "weight_msme", psu = NULL, keep = "mean")  %>% 
  mutate(indicator_group = ifelse(str_detect(indicator, "cope"), "Coping strategy", indicator_group))

factor_params <- list(
  wrap_sizes = list(indicator_name = 60, indicator_group = 25, group_name = 25, group_cat_val = NULL), 
  reverse_order = list(indicator_name = TRUE, indicator_group = FALSE, group_name = FALSE, group_cat_val = FALSE), 
  order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)

fig_data <- prep_fig_data(ests, factor_params)

labels <- list(
  title = "Challenges with loan repayment",
  subtitle =  "MSEs (%)",
  yax_ti = NULL,
  xax_ti = NULL,
  caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP)
)

figparams <- list(
  geom_type = "bar", # One of "bar" or "tile"
  bars = list(width = 0.8, position = "dodge", position_width = 0.9, labeltotal = FALSE, color = "white"), 
  valuelabels = list(show = FALSE, lab_hjust = 0, lab_face = "plain", lab_size = 3.5),
  catlabels = list(show = FALSE), 
  errorbars = list(show = FALSE, color = "#2374AB")
)

palette <- c("grey90", "#A2C3A4", "#C4F1BE", "#FF7B9C", "#CEE5F2")
names(palette) <- c("All businesses", "1 person", "2-10 people", "Women", "Men")   

maxy <- roundupN(max(fig_data$mean, na.rm = TRUE), 10)

scales <- list(
  fillcolor = list(palette = palette), 
  yaxis = list(limits = c(0, maxy), nbreaks = 4, type = "percent", expand = NULL, droplines = TRUE)
)

legend <- list(
  show = TRUE, 
  title = NULL, 
  nrows = 1, 
  ncols = 1, 
  reverse = FALSE
)

vars <- list(
  xvar = "indicator_name", yvar = "mean", fillvar = "group_cat_val"
)

facets <- list(
  type = "grid", 
  rows = "indicator_group", 
  cols = "city", 
  scales = "free_y", 
  space = "free", 
  drop_row_label = FALSE, 
  drop_col_label = FALSE, 
  add_dividers = TRUE
)

fig_flex(fig_data, vars, facets, figparams, scales, legend, labels, coord_flip = TRUE) + theme(axis.text.x = element_text(size = 9))


```

--- 

```{r, fig.width = 12, fig.asp = 0.55}
#| label: fig-cp_issues
#| echo: false
#| warning: false
#| fig-cap: "Consumer protection issues"
#| cap-location: margin

fig_notes <- "Notes: This figure shows responses to five questions relating to consumer risks, disputes and redress: (1) In the last 12 months, have you encountered any of the following issues with financial services?, (2) When you encountered an issue with digital financial services, did you raise an official complaint?, (3) Why didn't you raise a complaint?, (4) If you raised an official complaint, was the issue resolved? and (5) Have you ever stopped using any digital financial services due to fear of, or experiencing, the risks discussed above?"

indicators <- c(names(main_data_all)[str_detect(names(main_data_all), "cp_issues|cp_complaint")])

groups_l1 <- "city"
groups_l2 <- GROUPS[c("fullsample")]

# Adjustment for India
main_data_all <- main_data_all %>% mutate(cp_complaint_resolved_yes = ifelse(country == "India" & resp_sex_str == "Women", 0, cp_complaint_resolved_yes))

ests <- compute_summary_mainlevel_2g(indicators, groups_l1, groups_l2, data = main_data_all, weights = "weight_msme", psu = NULL, keep = "mean")

factor_params <- list(
  wrap_sizes = list(indicator_name = 60, indicator_group = 25, group_name = 25, group_cat_val = NULL), 
  reverse_order = list(indicator_name = TRUE, indicator_group = FALSE, group_name = FALSE, group_cat_val = FALSE), 
  order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)

fig_data <- prep_fig_data(ests, factor_params)

labels <- list(
  title = "Consumer protection issues",
  subtitle =  "MSEs (%)",
  yax_ti = NULL,
  xax_ti = NULL,
  caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP)
)

figparams <- list(
  geom_type = "bar", # One of "bar" or "tile"
  bars = list(width = 0.8, position = "dodge", position_width = 0.9, labeltotal = FALSE, color = "white"), 
  valuelabels = list(show = FALSE, lab_hjust = 0, lab_face = "plain", lab_size = 3.5),
  catlabels = list(show = FALSE), 
  errorbars = list(show = FALSE, color = "#2374AB")
)

palette <- c("grey90", "#A2C3A4", "#C4F1BE", "#FF7B9C", "#CEE5F2")
names(palette) <- c("All businesses", "1 person", "2-10 people", "Women", "Men")   

maxy <- roundupN(max(fig_data$mean, na.rm = TRUE), 10)

scales <- list(
  fillcolor = list(palette = palette), 
  yaxis = list(limits = c(0, maxy), nbreaks = 4, type = "percent", expand = NULL, droplines = TRUE)
)

legend <- list(
  show = TRUE, 
  title = NULL, 
  nrows = 1, 
  ncols = 1, 
  reverse = FALSE
)

vars <- list(
  xvar = "indicator_name", yvar = "mean", fillvar = "group_cat_val"
)

facets <- list(
  type = "grid", 
  rows = "indicator_group", 
  cols = "city", 
  scales = "free_y", 
  space = "free", 
  drop_row_label = FALSE, 
  drop_col_label = FALSE, 
  add_dividers = TRUE
)

fig_flex(fig_data, vars, facets, figparams, scales, legend, labels, coord_flip = TRUE) + theme(axis.text.x = element_text(size = 9))

```

## Risks and Resilience

```{r, fig.width = 12, fig.asp = 0.4}
#| label: fig-risks_types
#| echo: false
#| warning: false
#| fig-cap: "Risks: General"
#| cap-location: margin

indicators <- c("risk_largestimpact_shc_corr", "risk_largestimpact_shc_cost", "risk_largestimpact_shc_crme", "risk_largestimpact_shc_frau", "risk_largestimpact_shc_hlth", "risk_largestimpact_shc_none", "risk_largestimpact_shc_othr", "risk_largestimpact_shc_wthr")

groups_l1 <- "city"
groups_l2 <- GROUPS[c("resp_sex_str")]

ests <- compute_summary_mainlevel_2g(indicators, groups_l1, groups_l2, data = main_data_all, weights = "weight_msme", psu = NULL, keep = "mean")

factor_params <- list(
  wrap_sizes = list(indicator_name = 40, indicator_group = 25, group_name = 25, group_cat_val = NULL), 
  reverse_order = list(indicator_name = TRUE, indicator_group = FALSE, group_name = FALSE, group_cat_val = FALSE), 
  order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)

fig_data <- prep_fig_data(ests %>% filter(indicator_name != "No risks faced"), factor_params, valuelabel_thresh = 0.05)

labels <- list(
  title = "High impact shocks faced by MSEs",
  subtitle =  str_wrap("In the last 36 months (3 years), which of the following risks had the largest impact (most costly) in terms of losses or expenses incurred by the business?", 120), 
  yax_ti = NULL,
  xax_ti = NULL,
  caption = SOURCE
)

figparams <- list(
  geom_type = "bar", # One of "bar" or "tile"
  bars = list(width = 0.8, position = "dodge", position_width = 0.9, labeltotal = FALSE, color = "white"), 
  valuelabels = list(show = TRUE, lab_hjust = 0, lab_face = "plain", lab_size = 3.5),
  catlabels = list(show = FALSE), 
  errorbars = list(show = FALSE, color = "#2374AB")
)

palette <- c("#FF7B9C", "#CEE5F2")
names(palette) <- c("Women", "Men")   

maxy <- roundupN(max(fig_data$mean, na.rm = TRUE), 10)

scales <- list(
  fillcolor = list(palette = palette), 
  yaxis = list(limits = c(0, maxy), nbreaks = 5, type = "percent", expand = NULL, droplines = TRUE)
)

legend <- list(
  show = TRUE, 
  title = NULL, 
  nrows = 1, 
  ncols = 1, 
  reverse = FALSE
)

vars <- list(
  xvar = "indicator_name", yvar = "mean", fillvar = "group_cat_val"
)

facets <- list(
  type = "grid", 
  rows = "indicator_group", 
  cols = "city", 
  scales = "free_y", 
  space = "free",
  drop_row_label = TRUE, 
  drop_col_label = FALSE, 
  add_dividers = FALSE
)

fig_flex(fig_data, vars, facets, figparams, scales, legend, labels, coord_flip = TRUE)


```

--- 

```{r, fig.width = 12, fig.asp = 0.35}
#| label: fig-risks_climate_types
#| echo: false
#| warning: false
#| fig-cap: "Risks: Climate"
#| cap-location: margin

indicators <- c("risk_weather_type_heat", "risk_weather_type_droughts", "risk_weather_type_floodstyphoon", "risk_weather_type_other", "risk_weather_type_any")

groups_l1 <- "city"
groups_l2 <- GROUPS[c("resp_sex_str")]

ests <- compute_summary_mainlevel_2g(indicators, groups_l1, groups_l2, data = main_data_all, weights = "weight_msme", psu = NULL, keep = "mean")

factor_params <- list(
  wrap_sizes = list(indicator_name = 40, indicator_group = 25, group_name = 25, group_cat_val = NULL), 
  reverse_order = list(indicator_name = TRUE, indicator_group = FALSE, group_name = FALSE, group_cat_val = FALSE), 
  order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)

fig_data <- prep_fig_data(ests, factor_params, valuelabel_thresh = 0.05)

labels <- list(
  title = "Climate shocks faced by MSEs",
  subtitle =  str_wrap("In the last 36 months (3 years), has your business or the supply chain of your business experienced any of the following weather-related risks?", 120), 
  yax_ti = NULL,
  xax_ti = NULL,
  caption = str_wrap(paste(SOURCE, "Notes: *For Indonesia and India, extreme rain, floods or landslides includes typhoons or cyclones"), CAP_WRAP)
)

figparams <- list(
  geom_type = "bar", # One of "bar" or "tile"
  bars = list(width = 0.8, position = "dodge", position_width = 0.9, labeltotal = FALSE, color = "white"), 
  valuelabels = list(show = TRUE, lab_hjust = 0, lab_face = "plain", lab_size = 3.5),
  catlabels = list(show = FALSE), 
  errorbars = list(show = FALSE, color = "#2374AB")
)

palette <- c("#FF7B9C", "#CEE5F2")
names(palette) <- c("Women", "Men")     

maxy <- roundupN(max(fig_data$mean, na.rm = TRUE), 20)

scales <- list(
  fillcolor = list(palette = palette, direction = NULL), 
  yaxis = list(limits = c(0, maxy), nbreaks = 5, type = "percent", expand = NULL, droplines = TRUE)
)

legend <- list(
  show = TRUE, 
  title = NULL, 
  nrows = 1, 
  ncols = 1, 
  reverse = FALSE
)

vars <- list(
  xvar = "indicator_name", yvar = "mean", fillvar = "group_cat_val"
)

facets <- list(
  type = "grid", 
  rows = "indicator_group", 
  cols = "city", 
  scales = "free_y", 
  space = "free",
  drop_row_label = TRUE, 
  drop_col_label = FALSE, 
  add_dividers = FALSE
)

fig_flex(fig_data, vars, facets, figparams, scales, legend, labels, coord_flip = TRUE)


```

--- 

```{r, fig.width = 12, fig.asp = 0.55}
#| label: fig-risks_impacts
#| echo: false
#| warning: false
#| fig-cap: "Risks: Impacts"
#| cap-location: margin

fig_notes <- c("Notes: This figure shows responses to three questions related to the impact of weather shocks: (1) Please think about the weather risk that affected you the most in the last 36 months and describe how the weather risk impacted your business operations, (2) What actions did the business take to cope with the impacts of this weather risk? abd (3) What is the condition of the business now, compared to before the weather risk occurred?")

indicators <- c(names(main_data_all)[str_detect(names(main_data_all), "weather_impact")], names(main_data_all)[str_detect(names(main_data_all), "weather_cope")], names(main_data_all)[str_detect(names(main_data_all), "weather_cond")])

groups <- GROUPS[c("city")]

ests <- compute_summary_mainlevel_1g(indicators, groups, data = main_data_all, weights = "weight_msme", psu = NULL, keep = "mean")

factor_params <- list(
  wrap_sizes = list(indicator_name = 60, indicator_group = 25, group_name = 25, group_cat_val = NULL), 
  reverse_order = list(indicator_name = TRUE, indicator_group = FALSE, group_name = FALSE, group_cat_val = FALSE), 
  order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)

fig_data <- prep_fig_data(ests, factor_params)

labels <- list(
  title = "Impacts and coping strategies of MSEs",
  subtitle =  "MSEs exposed to climate shock in past 36 months (%)",
  yax_ti = NULL,
  xax_ti = NULL,
  caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP)
)

figparams <- list(
  geom_type = "tile", # One of "bar" or "tile"
  tiles = list(color = "white"), 
  valuelabels = list(show = TRUE, lab_hjust = 0.5, lab_face = "plain", lab_size = 3),
  catlabels = list(show = FALSE), 
  errorbars = list(show = FALSE, color = "#2374AB")
)

scales <- list(
  fillcolor = list(palette = "Blues", direction = 1), 
  yaxis = list(limits = c(0, 1), nbreaks = 5, type = "percent", expand = NULL, droplines = TRUE)
)

legend <- list(
  show = FALSE, 
  title = NULL, 
  nrows = 1, 
  ncols = 1, 
  reverse = FALSE
)

vars <- list(
  xvar = "indicator_name", yvar = "group_cat_val", fillvar = "mean"
)

facets <- list(
  type = "grid", 
  rows = "indicator_group", 
  cols = "group_name", 
  scales = "free", 
  space = "free",
  drop_row_label = FALSE, 
  drop_col_label = FALSE, 
  add_dividers = FALSE
)

fig_flex(fig_data, vars, facets, figparams, scales, legend, labels, coord_flip = TRUE)


```

---

```{r, fig.width = 12, fig.asp = 0.45}
#| label: fig-resilience_financial
#| echo: false
#| warning: false
#| fig-cap: "Financial resilience"
#| cap-location: margin

fig_notes <- c("Notes: This figure is based on responses to two questions: (1) Imagine that your business had an emergency and needed to pay money equivalent to 1 month of business revenue, how difficult would it be for you to come up with that amount in the next 7 days? and (2) What would be the MAIN source of money that the business would use to come up with this lump sum amount? The percentages in the right panel correspond to the % of MSEs reporting that raising emergency funds is possible.")

indicators <- c("resi_efunds_firm_diff_1",   "resi_efunds_firm_diff_2", "resi_efunds_firm_diff_3", "resi_efunds_firm_diff_4", 
  "resi_efunds_firm_source_family", "resi_efunds_firm_source_work", "resi_efunds_firm_source_firmcsh", "resi_efunds_firm_source_hhcsh", "resi_efunds_firm_source_borrow", "resi_efunds_firm_source_sellassets", "resi_efunds_firm_source_other")

groups <- GROUPS[("city")]

ests <- compute_summary_mainlevel_1g(indicators, groups, data = main_data_all, weights = "weight_msme", psu = NULL, keep = "mean")

factor_params <- list(
  wrap_sizes = list(indicator_name = 60, indicator_group = 40, group_name = 25, group_cat_val = NULL), 
  reverse_order = list(indicator_name = TRUE, indicator_group = FALSE, group_name = FALSE, group_cat_val = FALSE), 
  order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)

fig_data <- prep_fig_data(ests, factor_params, valuelabel_thresh = 0.05)


labels <- list(
  title = NULL, 
  subtitle =  NULL, 
  yax_ti = NULL,
  xax_ti = NULL,
  caption = NULL
)

figparams <- list(
  geom_type = "bar", # One of "bar" or "tile"
  bars = list(width = 0.9, position = "stack", labeltotal = FALSE, color = "white"), 
  valuelabels = list(show = TRUE, lab_hjust = 0.5, lab_vjust = 0.5, lab_face = "plain", lab_size = 3.5),
  catlabels = list(show = FALSE), 
  errorbars = list(show = FALSE)
)

palette <- c("#A2C3A4", "#C4F1BE", "#FF9F1C", "#DB504A", "#31AFD4", "#CEE5F2", "#CE6A85", "#985277", "#FAA275", "#FF8C61", "grey80")
names(palette) <- unique(fig_data$indicator_name)

scales <- list(
  fillcolor = list(palette = palette, direction = NULL), 
  yaxis = list(limits = c(0, 1), nbreaks = 5, type = "percent", expand = NULL, droplines = FALSE)
)

legend <- list(
  show = TRUE, 
  title = NULL, 
  direction = "horizontal",
  nrows = 2, 
  ncols = 1, 
  reverse = TRUE
)

vars <- list(
  xvar = "group_cat_val", yvar = "mean", fillvar = "indicator_name"
)

facets <- list(
  type = "grid", 
  rows = "group_name", 
  cols = "indicator_group", 
  scales = "free", 
  space = "free",
  drop_row_label = TRUE, 
  drop_col_label = FALSE, 
  add_dividers = FALSE
)

p1 <- fig_flex(fig_data %>% filter(indicator %in% names(main_data_all)[str_detect(names(main_data_all), "efunds_firm_diff")]),
                     vars, facets, figparams, scales, legend, labels, coord_flip = TRUE) 

facets <- list(
  type = "grid", 
  rows = "group_name", 
  cols = "indicator_group", 
  scales = "free", 
  space = "free",
  drop_row_label = TRUE, 
  drop_col_label = FALSE, 
  add_dividers = FALSE
)

p2 <- fig_flex(fig_data %>% filter(indicator %in% names(main_data_all)[str_detect(names(main_data_all), "efunds_firm_source")]),
                     vars, facets, figparams, scales, legend, labels, coord_flip = TRUE)  

p1 + p2 + plot_layout(axes = "collect") + 
  plot_annotation(title = "Financial resilience: Access to- and source of- emergency funds", 
                  subtitle = "MSEs (%)", 
                  caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP), 
                  theme = theme(plot.title = element_text(size = 14, hjust = 0, face = 'bold', color = 'black'), 
                                      plot.caption=element_text(hjust=0, color="gray30", size=12),
                                      plot.title.position = "plot",
                                      plot.caption.position = "plot")) 

```

--- 

```{r, fig.width = 12, fig.asp = 0.475}
#| label: fig-resilience_nonfinancial
#| echo: false
#| warning: false
#| fig-cap: "Non-financial dimensions of business resilience"
#| cap-location: margin

fig_notes <- "Notes: This figure is based on responses to three questions (1) (To owners only) If your household has an emergency that requires  [1/20 of GNI per capita] in cash within the next 7 days, would you need to take resources from the business to cover this emergency, (2) If your main customer were to permanently stop purchasing from your business, or if your main suplier were to close operations, how difficult would this be for your business? and (3) If you needed support to sustain your business operations, how confident are you in relying on your network?"

indicators <- c(names(main_data_all)[str_detect(names(main_data_all), "efunds_hh_owner")],
                names(main_data_all)[str_detect(names(main_data_all), "suppchain_cust")], 
                names(main_data_all)[str_detect(names(main_data_all), "network_conf")])
indicators <- indicators[!str_detect(indicators, "score")]

groups <- GROUPS[("city")]

ests <- compute_summary_mainlevel_1g(indicators, groups, data = main_data_all, weights = "weight_msme", psu = NULL, keep = "mean")

factor_params <- list(
  wrap_sizes = list(indicator_name = 60, indicator_group = 40, group_name = 25, group_cat_val = NULL), 
  reverse_order = list(indicator_name = TRUE, indicator_group = FALSE, group_name = FALSE, group_cat_val = FALSE), 
  order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)

fig_data <- prep_fig_data(ests, factor_params)

fct_levels <- c("No", "Yes", "Not difficult at all",  "Somewhat difficult", "Very difficult", "Very confident", "Somewhat confident", "Not confident")

fig_data <- fig_data %>% mutate(indicator_name = fct_rev(factor(indicator_name, levels = fct_levels, ordered = TRUE)))

labels <- list(
  title = NULL, 
  subtitle =  NULL, 
  yax_ti = NULL,
  xax_ti = NULL,
  caption = NULL
)

figparams <- list(
  geom_type = "bar", # One of "bar" or "tile"
  bars = list(width = 0.9, position = "stack", labeltotal = FALSE, color = "white"), 
  valuelabels = list(show = TRUE, lab_hjust = 0.5, lab_vjust = 0.5, lab_face = "plain", lab_size = 3.5),
  catlabels = list(show = FALSE), 
  errorbars = list(show = FALSE)
)

palette <- c("#DB504A", "#31AFD4", "#A2C3A4", "#FF9F1C", "#DB504A", "#DB504A", "#FF9F1C", "#A2C3A4")
names(palette) <- unique(fig_data$indicator_name)

scales <- list(
  fillcolor = list(palette = palette, direction = NULL), 
  yaxis = list(limits = c(0, 1), nbreaks = 5, type = "percent", expand = NULL, droplines = FALSE)
)

legend <- list(
  show = TRUE, 
  title = NULL, 
  direction = "horizontal",
  nrows = 3, 
  ncols = 1, 
  reverse = TRUE
)

vars <- list(
  xvar = "group_cat_val", yvar = "mean", fillvar = "indicator_name"
)

facets <- list(
  type = "grid", 
  rows = "group_name", 
  cols = "indicator_group", 
  scales = "free", 
  space = "free",
  drop_row_label = TRUE, 
  drop_col_label = FALSE, 
  add_dividers = FALSE
)


p1 <- fig_flex(fig_data %>% filter(indicator %in% names(main_data_all)[str_detect(names(main_data_all), "resi_efunds_hh_owner")]),
                     vars, facets, figparams, scales, legend, labels, coord_flip = TRUE) 


facets <- list(
  type = "grid", 
  rows = "group_name", 
  cols = "indicator_group", 
  scales = "free", 
  space = "free",
  drop_row_label = TRUE, 
  drop_col_label = FALSE, 
  add_dividers = FALSE
)


p2 <- fig_flex(fig_data %>% filter(indicator %in% names(main_data_all)[str_detect(names(main_data_all), "suppchain_cust")]), 
               vars, facets, figparams, scales, legend, labels, coord_flip = TRUE) 

p3 <- fig_flex(fig_data %>% filter(indicator %in% names(main_data_all)[str_detect(names(main_data_all), "network_conf")]), 
                     vars, facets, figparams, scales, legend, labels, coord_flip = TRUE) 


p1 + p2 + p3 + plot_layout(axes = "collect") + 
  plot_annotation(title = "Other dimensions of business resilience", 
                  subtitle = "MSEs (%)", 
                  caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP), 
                  theme = theme(plot.title = element_text(size = 14, hjust = 0, face = 'bold', color = 'black'), 
                                      plot.caption=element_text(hjust=0, color="gray30", size=12),
                                      plot.title.position = "plot",
                                      plot.caption.position = "plot")) 

```

---

```{r, fig.width = 12, fig.asp = 0.4}
#| label: fig-resilience_overview
#| echo: false
#| warning: false
#| fig-cap: "Access to connectivity and devices"
#| cap-location: margin

fig_notes <- "Notes: The overall resilience score is a composite variable that considers the the degree of difficulty of raising emergency funds, the degree of difficulty of losing a main customer or supplier and the degree of confidence in the owner's social networks an resilience capital and whether the business finances are insulated from household shocks. The score is normalized so that a score of 0 denotes the lowest potential resilience and a score of 1 denotes the highest potential resilience."

indicators <- c(names(main_data_all)[str_detect(names(main_data_all), "resi_capital")])
indicators <- indicators[!str_detect(indicators, "resi_capital_score_v1|resi_capital_score_v2|resi_capital_score_v3")]
indicators <- c(indicators, "resi_capital_score_v3_norm")

groups_l1 <- "city"
groups_l2 <- GROUPS[c("resp_sex_str")]

ests <- compute_summary_mainlevel_2g(indicators, groups_l1, groups_l2, data = main_data_all, weights = "weight_msme", psu = NULL, keep = "mean")

factor_params <- list(
  wrap_sizes = list(indicator_name = 80, indicator_group = 25, group_name = 25, group_cat_val = NULL), 
  reverse_order = list(indicator_name = TRUE, indicator_group = FALSE, group_name = FALSE, group_cat_val = FALSE), 
  order_vars = list(indicator_name = NULL, indicator_group = NULL, group_name = NULL, group_cat_val = NULL)
)

fig_data <- prep_fig_data(ests, factor_params)
fig_data <- resilience_capital(fig_data) %>% mutate(indicator_group2 = fct_inorder(indicator_group2))

labels <- list(
  title = "Resilience capital",
  subtitle =  NULL,
  yax_ti = NULL,
  xax_ti = NULL,
  caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP)
)

figparams <- list(
  geom_type = "tile", # One of "bar" or "tile"
  tiles = list(color = "white"), 
  valuelabels = list(show = TRUE, lab_hjust = 0.5, lab_face = "plain", lab_size = 3.5),
  catlabels = list(show = FALSE), 
  errorbars = list(show = FALSE)
)

scales <- list(
  fillcolor = list(palette = "identity", direction = NULL), 
  yaxis = list(limits = c(0, 1), nbreaks = 5, type = "percent", expand = NULL, droplines = TRUE)
)

legend <- list(
  show = FALSE, 
  title = NULL, 
  nrows = 1, 
  ncols = 1, 
  reverse = FALSE
)

vars <- list(
  xvar = "indicator_name", yvar = "group_cat_val", fillvar = "fillcolor"
)

facets <- list(
  type = "grid", 
  rows = "indicator_group2", 
  cols = "city", 
  scales = "free", 
  space = "free",
  drop_row_label = FALSE, 
  drop_col_label = FALSE, 
  add_dividers = FALSE
)

fig_flex(fig_data, vars, facets, figparams, scales, legend, labels, coord_flip = TRUE) + geom_vline(xintercept = c(1.5, 2.5), color = "black")


```

---

```{r, fig.width = 12, fig.asp = 0.4}
#| label: fig-reg_resilience_digtechadoption
#| echo: false
#| warning: false
#| fig-cap: "Relationship between prior exposure to weather shock and investment in adaptation"
#| cap-location: margin

fig_notes <- "Notes: The results shown are based on a linear regression model that measures the effect of prior expsoure to a climate shock on the firm's propsentiy to invest in adaptation. This model includes controls for two variables: years of experience and educational attainment. The regression parameters are used to compute predicted probabilities for businesses with and without prior exposure to a climate shocks, with the average years of experience running the business in the sample and with secondary-level educational attainment."

# Defining regressions
  depvars <- c("risk_weather_adaptspend")
  depvar_labels <- INDICATORS[depvars]
  maineffects <- c("risk_weather_type_any")
  effect_labels <- c("(Intercept)" = "No exposure to prior weather shock", INDICATORS[maineffects])
  confounds <- c("resp_experience_c", "resp_education_agg4_shc_non", "resp_education_agg4_shc_pri",  "resp_education_agg4_shc_trt")
  
combinations <- expand.grid(depvars, COUNTRIES, stringsAsFactors = FALSE)
depvars <- combinations[[1]]
countries <- combinations[[2]]
  
# Running regressions
ests <- bind_rows(
    map2(depvars, countries, model_and_prepfig, maineffect = maineffects, confounds = NULL, data = main_data_all, depvar_labels = depvar_labels, effect_labels = effect_labels),
    map2(depvars, countries, model_and_prepfig, maineffect = maineffects, confounds = confounds, data = main_data_all, depvar_labels = depvar_labels, effect_labels = effect_labels)
  )

factor_params <- list(
  wrap_sizes = list(depvar_label = 25, effect_label = 70, model_type = 25), 
  reverse_order = list(depvar_label = TRUE, effect_label = TRUE, model_type = FALSE), 
  order_vars = list(depvar_label = NULL, effect_label = NULL, model_type = NULL)
)

fig_data <- prep_reg_data(prep_reg_factors(ests, factor_params, include_valuelabel = FALSE), b_round = 2) %>% 
  mutate(effect_label = str_replace(effect_label, "Climate risk: ", ""))


 labels <- list(
      title = "Observational estimates of the effect of exposure to weather shocks on investments in adaptation",
      subtitle = "",
      y = "Predicted probability of investing in adaptation",
      x = NULL,
      caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP*1.2)
    )


 facets <- list(type = "grid", 
                rows ="model_type", 
                cols = "city", 
                scales = "free", 
                space = "free", 
                drop_row_label = FALSE) 

  miny <- round(min(fig_data$fig_data), 2) 
  maxy <- round(max(fig_data$fig_data), 2) 
  buffer <- (maxy - miny)/100
  miny <- miny - buffer*4
  if (miny > 0) { miny <- 0 }
  maxy <- maxy + buffer*4

scales <- list(
  y = list(limits = c(miny,maxy), position = "left", nbreaks = 3), 
  x = list(position = "bottom")
)

 fig_regests(fig_data, labels, facets = facets, barparams, scales, effect_desc = "The effect of prior exposure to a weather shock on investment in adaptations", coord_flip = TRUE)
 
```

```{r, fig.width = 12, fig.asp = 0.4}
#| label: fig-reg_digtech_resilience
#| echo: false
#| warning: false
#| fig-cap: "Relationship between overall technology adoption & resilience"
#| cap-location: margin

# Defining regressions
  depvars <- c("resi_capital_financial")
  depvar_labels <- INDICATORS[depvars]
  maineffects <- c("tech_uses_adoption_score_c")
  effect_labels <- c("(Intercept)" = "Baseline", INDICATORS[maineffects])
  confounds <- c("resp_experience_c", "resp_education_agg4_shc_non", "resp_education_agg4_shc_pri",  "resp_education_agg4_shc_trt")
  
combinations <- expand.grid(depvars, COUNTRIES, stringsAsFactors = FALSE)
depvars <- combinations[[1]]
countries <- combinations[[2]]
  
# Running regressions
ests <- bind_rows(
    map2(depvars, countries, model_and_prepfig, maineffect = maineffects, confounds = confounds, data = main_data_all, depvar_labels = depvar_labels, effect_labels = effect_labels)
  )

# Preparing figure data
factor_params <- list(
  wrap_sizes = list(depvar_label = 20, effect_label = 55, model_type = 25), 
  reverse_order = list(depvar_label = TRUE, effect_label = TRUE, model_type = FALSE), 
  order_vars = list(depvar_label = NULL, effect_label = NULL, model_type = NULL)
)

fig_data <- prep_reg_data(prep_reg_factors(ests, factor_params, include_valuelabel = FALSE))

 labels <- list(
      title = "Observational estimates of the relationship between digital technology and financial resilience",
      subtitle = "",
      y = "Predicted probability of financial resilience (%)",
      x = NULL,
      caption = str_wrap(paste(SOURCE, fig_notes), CAP_WRAP*1.2)
    )
 
 barparams <- list(
  bars = list(width = 0.6, color = "grey90"), 
  valuelabels = list(show = FALSE, lab_vjust = 0, lab_hjust = 0, lab_ndgy = 0, lab_ndgx = 0.25, lab_face = "plain", lab_size = 3), 
  arrowlabels = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0.5, lab_ndgy = 0, lab_ndgx = -0.25,  lab_face = "plain", lab_size = 3), 
  baselinelabel = list(show = TRUE, lab_vjust = 0.5, lab_hjust = 0, lab_ndgy = 0, lab_ndgx = 0,  lab_face = "bold", lab_size = 3.5)
) 

scales <- list(
  y = list(limits = c(0, 1), position = "left", nbreaks = 2), 
  x = list(txtwrap = 50, position = "bottom")
)

facets <- list(type = "grid", cols ="country", rows = "depvar_label", scales = "free", space = "fixed", drop_row_label = TRUE) 
    
fig_regests(fig_data, labels, facets = facets, barparams, scales, effect_desc = "Effect (in percentage points) of general digital technology on probability firm can access emergency funds", coord_flip = TRUE)

```
